<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#FF6B00">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TurboWash Laundry</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --orange: #FF6B00;
  --orange-light: #FF8C33;
  --orange-dark: #CC5500;
  --yellow: #FFD700;
  --yellow-light: #FFE44D;
  --dark: #1A1A2E;
  --dark2: #16213E;
  --dark3: #0F3460;
  --card: #ffffff;
  --card2: #f8f9ff;
  --text: #1A1A2E;
  --text2: #555577;
  --text3: #8888aa;
  --border: #e8eaf0;
  --success: #00C853;
  --warning: #FFB300;
  --danger: #F44336;
  --info: #2196F3;
  --purple: #7C4DFF;
  --shadow: 0 4px 20px rgba(255,107,0,0.15);
  --shadow2: 0 2px 10px rgba(0,0,0,0.08);
  --radius: 16px;
  --radius2: 12px;
  --radius3: 8px;
  --bottom-nav: 70px;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; overflow:hidden; font-family:'Poppins',sans-serif; background:#f0f2f8; color:var(--text); }
#app { height:100vh; overflow:hidden; display:flex; flex-direction:column; }

/* ===== SCROLLABLE CONTENT ===== */
.page-content { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding-bottom:calc(var(--bottom-nav) + 20px); }
.page-content::-webkit-scrollbar { display:none; }

/* ===== LOGIN PAGE ===== */
#loginPage {
  min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center;
  background: linear-gradient(135deg, #1A1A2E 0%, #16213E 50%, #0F3460 100%);
  padding:20px; position:relative; overflow:hidden;
}
#loginPage::before {
  content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%;
  background: radial-gradient(circle at 30% 50%, rgba(255,107,0,0.15) 0%, transparent 50%),
              radial-gradient(circle at 70% 30%, rgba(255,215,0,0.1) 0%, transparent 40%);
  animation: bgPulse 6s ease-in-out infinite alternate;
}
@keyframes bgPulse { 0%{transform:scale(1)} 100%{transform:scale(1.1)} }
.login-card {
  width:100%; max-width:400px; background:rgba(255,255,255,0.05);
  backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.1);
  border-radius:24px; padding:40px 32px; position:relative; z-index:1;
  box-shadow: 0 25px 50px rgba(0,0,0,0.3);
}
.login-logo { text-align:center; margin-bottom:8px; }
.login-logo img { width:220px; height:auto; border-radius:12px; }
.login-tagline { text-align:center; color:rgba(255,255,255,0.5); font-size:12px; margin-bottom:32px; letter-spacing:1px; text-transform:uppercase; }
.login-title { text-align:center; color:white; font-family:'Nunito',sans-serif; font-weight:800; font-size:22px; margin-bottom:6px; }
.login-subtitle { text-align:center; color:rgba(255,255,255,0.5); font-size:13px; margin-bottom:28px; }
.form-group { margin-bottom:16px; }
.form-group label { display:block; color:rgba(255,255,255,0.7); font-size:12px; font-weight:600; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px; }
.form-group input {
  width:100%; padding:14px 16px; background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.15); border-radius:12px;
  color:white; font-size:15px; font-family:'Poppins',sans-serif;
  transition:all 0.3s; outline:none;
}
.form-group input::placeholder { color:rgba(255,255,255,0.3); }
.form-group input:focus { border-color:var(--orange); background:rgba(255,107,0,0.1); box-shadow:0 0 0 3px rgba(255,107,0,0.2); }
.btn-login {
  width:100%; padding:16px; background:linear-gradient(135deg, var(--orange), var(--orange-light));
  border:none; border-radius:12px; color:white; font-size:16px; font-weight:700;
  font-family:'Nunito',sans-serif; cursor:pointer; transition:all 0.3s;
  box-shadow: 0 8px 25px rgba(255,107,0,0.4); margin-top:8px;
  display:flex; align-items:center; justify-content:center; gap:8px;
}
.btn-login:active { transform:scale(0.97); }
.login-error { background:rgba(244,67,54,0.2); border:1px solid rgba(244,67,54,0.4); border-radius:10px; padding:12px 16px; color:#ff8a80; font-size:13px; margin-top:12px; text-align:center; display:none; }

/* ===== TOP HEADER ===== */
.top-header {
  background:linear-gradient(135deg, var(--dark) 0%, var(--dark2) 100%);
  padding:12px 16px; display:flex; align-items:center; gap:12px;
  position:sticky; top:0; z-index:100; box-shadow:0 2px 15px rgba(0,0,0,0.2);
  min-height:60px;
}
.header-logo { height:36px; width:auto; border-radius:6px; }
.header-title { flex:1; }
.header-title h1 { color:white; font-family:'Nunito',sans-serif; font-weight:900; font-size:16px; line-height:1.2; }
.header-title p { color:rgba(255,255,255,0.5); font-size:10px; }
.header-actions { display:flex; gap:8px; align-items:center; }
.header-btn {
  width:36px; height:36px; border-radius:10px; border:none; cursor:pointer;
  display:flex; align-items:center; justify-content:center; font-size:16px;
  background:rgba(255,255,255,0.1); color:white; transition:all 0.2s; position:relative;
}
.header-btn:active { transform:scale(0.9); }
.badge {
  position:absolute; top:-4px; right:-4px; background:var(--danger);
  color:white; font-size:9px; font-weight:700; border-radius:10px;
  padding:1px 5px; min-width:16px; text-align:center; font-family:'Nunito',sans-serif;
}

/* ===== BOTTOM NAV ===== */
.bottom-nav {
  height:var(--bottom-nav); background:white; display:flex; align-items:center;
  border-top:1px solid var(--border); position:fixed; bottom:0; left:0; right:0; z-index:100;
  box-shadow:0 -4px 20px rgba(0,0,0,0.08);
}
.nav-item {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:3px; padding:8px 4px; cursor:pointer; transition:all 0.2s; position:relative; border:none; background:none;
}
.nav-item .nav-icon { font-size:20px; transition:transform 0.2s; }
.nav-item .nav-label { font-size:9px; font-weight:600; color:var(--text3); transition:color 0.2s; text-transform:uppercase; letter-spacing:0.3px; }
.nav-item.active .nav-icon { transform:scale(1.1); }
.nav-item.active .nav-label { color:var(--orange); }
.nav-item.active::after { content:''; position:absolute; bottom:-1px; left:50%; transform:translateX(-50%); width:32px; height:3px; background:var(--orange); border-radius:3px 3px 0 0; }
.nav-fab {
  width:52px; height:52px; border-radius:16px; background:linear-gradient(135deg,var(--orange),var(--orange-light));
  border:none; display:flex; align-items:center; justify-content:center; cursor:pointer;
  font-size:24px; color:white; box-shadow:0 6px 20px rgba(255,107,0,0.4);
  transform:translateY(-10px); transition:all 0.2s; flex-shrink:0;
}
.nav-fab:active { transform:translateY(-10px) scale(0.93); }

/* ===== PAGES ===== */
.page { display:none; flex:1; flex-direction:column; height:100%; }
.page.active { display:flex; }

/* ===== DASHBOARD ===== */
.dash-greeting { padding:16px 16px 8px; }
.dash-greeting h2 { font-family:'Nunito',sans-serif; font-weight:800; font-size:20px; color:var(--text); }
.dash-greeting p { color:var(--text2); font-size:13px; }
.overdue-banner {
  margin:8px 16px; background:linear-gradient(135deg,#F44336,#E53935);
  border-radius:var(--radius2); padding:12px 16px; display:flex; align-items:center; gap:10px;
  cursor:pointer; box-shadow:0 4px 15px rgba(244,67,54,0.3); animation:pulse 2s infinite;
}
@keyframes pulse { 0%,100%{box-shadow:0 4px 15px rgba(244,67,54,0.3)} 50%{box-shadow:0 4px 25px rgba(244,67,54,0.6)} }
.overdue-banner .icon { font-size:22px; }
.overdue-banner .text { flex:1; color:white; }
.overdue-banner .text b { font-size:14px; font-weight:700; display:block; }
.overdue-banner .text span { font-size:11px; opacity:0.85; }
.overdue-banner .arrow { color:rgba(255,255,255,0.7); font-size:16px; }
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:8px 16px; }
.stat-card {
  background:white; border-radius:var(--radius2); padding:14px; box-shadow:var(--shadow2);
  border-left:4px solid transparent; transition:transform 0.2s; cursor:default;
}
.stat-card:active { transform:scale(0.97); }
.stat-card .stat-icon { font-size:22px; margin-bottom:6px; }
.stat-card .stat-val { font-family:'Nunito',sans-serif; font-weight:900; font-size:26px; line-height:1; }
.stat-card .stat-lbl { font-size:11px; color:var(--text2); margin-top:2px; font-weight:600; }
.stat-card.orange { border-left-color:var(--orange); } .stat-card.orange .stat-val { color:var(--orange); }
.stat-card.yellow { border-left-color:var(--warning); } .stat-card.yellow .stat-val { color:var(--warning); }
.stat-card.green { border-left-color:var(--success); } .stat-card.green .stat-val { color:var(--success); }
.stat-card.red { border-left-color:var(--danger); } .stat-card.red .stat-val { color:var(--danger); }
.stat-card.blue { border-left-color:var(--info); } .stat-card.blue .stat-val { color:var(--info); }
.stat-card.purple { border-left-color:var(--purple); } .stat-card.purple .stat-val { color:var(--purple); }
.section-header { padding:12px 16px 6px; display:flex; align-items:center; justify-content:space-between; }
.section-header h3 { font-family:'Nunito',sans-serif; font-weight:800; font-size:15px; color:var(--text); }
.section-header a { color:var(--orange); font-size:12px; font-weight:600; cursor:pointer; }
.recent-orders { padding:0 16px; display:flex; flex-direction:column; gap:8px; }

/* ===== ORDER CARD ===== */
.order-card {
  background:white; border-radius:var(--radius2); padding:14px; box-shadow:var(--shadow2);
  cursor:pointer; transition:all 0.2s; border:1px solid var(--border);
}
.order-card:active { transform:scale(0.98); box-shadow:var(--shadow); }
.order-card-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:8px; }
.order-num { font-family:'Nunito',sans-serif; font-weight:800; font-size:13px; color:var(--orange); }
.order-date { font-size:12px; color:var(--text2); margin-top:2px; font-weight:600; }
.status-badge {
  padding:3px 10px; border-radius:20px; font-size:10px; font-weight:700;
  text-transform:uppercase; letter-spacing:0.5px;
}
.status-received { background:#E3F2FD; color:#1565C0; }
.status-inprogress { background:#FFF8E1; color:#F57F17; }
.status-ready { background:#E8F5E9; color:#2E7D32; }
.status-delivered { background:#F3E5F5; color:#6A1B9A; }
.status-cancelled { background:#FFEBEE; color:#B71C1C; }
.order-customer { font-weight:600; font-size:14px; color:var(--text); }
.order-phone { font-size:12px; color:var(--text2); }
.order-services { display:flex; flex-wrap:wrap; gap:4px; margin:6px 0; }
.service-tag { background:var(--card2); border:1px solid var(--border); border-radius:6px; padding:2px 8px; font-size:10px; color:var(--text2); font-weight:600; }
.order-card-bottom { display:flex; align-items:center; justify-content:space-between; padding-top:8px; border-top:1px solid var(--border); }
.order-amount { font-family:'Nunito',sans-serif; font-weight:800; font-size:15px; color:var(--text); }
.order-balance { font-size:11px; color:var(--danger); font-weight:600; }
.order-due { font-size:12px; color:var(--text2); font-weight:600; }
.order-due.overdue { color:var(--danger); font-weight:700; }
.order-due.due-today { color:var(--warning); font-weight:700; }

/* ===== SEARCH BAR ===== */
.search-bar { padding:12px 16px; }
.search-input-wrap { position:relative; }
.search-input-wrap input {
  width:100%; padding:12px 16px 12px 42px; background:white;
  border:1px solid var(--border); border-radius:var(--radius2); font-size:14px;
  font-family:'Poppins',sans-serif; outline:none; color:var(--text);
  box-shadow:var(--shadow2); transition:all 0.3s;
}
.search-input-wrap input:focus { border-color:var(--orange); box-shadow:0 0 0 3px rgba(255,107,0,0.1); }
.search-input-wrap .search-icon { position:absolute; left:14px; top:50%; transform:translateY(-50%); font-size:16px; }

/* ===== FILTER TABS ===== */
.filter-tabs { display:flex; gap:8px; padding:4px 16px 12px; overflow-x:auto; }
.filter-tabs::-webkit-scrollbar { display:none; }
.filter-tab {
  padding:6px 14px; border-radius:20px; font-size:12px; font-weight:600;
  border:1.5px solid var(--border); background:white; color:var(--text2);
  cursor:pointer; white-space:nowrap; transition:all 0.2s; flex-shrink:0;
}
.filter-tab.active { background:var(--orange); border-color:var(--orange); color:white; box-shadow:0 3px 10px rgba(255,107,0,0.3); }

/* ===== BUTTONS ===== */
.btn {
  display:inline-flex; align-items:center; gap:6px; padding:12px 20px;
  border-radius:var(--radius2); font-size:14px; font-weight:600; cursor:pointer;
  border:none; font-family:'Poppins',sans-serif; transition:all 0.2s;
}
.btn:active { transform:scale(0.96); }
.btn-primary { background:linear-gradient(135deg,var(--orange),var(--orange-light)); color:white; box-shadow:0 4px 15px rgba(255,107,0,0.3); }
.btn-secondary { background:var(--card2); color:var(--text); border:1.5px solid var(--border); }
.btn-danger { background:linear-gradient(135deg,#F44336,#E53935); color:white; box-shadow:0 4px 15px rgba(244,67,54,0.3); }
.btn-success { background:linear-gradient(135deg,var(--success),#00A846); color:white; box-shadow:0 4px 15px rgba(0,200,83,0.3); }
.btn-info { background:linear-gradient(135deg,var(--info),#1976D2); color:white; }
.btn-sm { padding:7px 14px; font-size:12px; border-radius:8px; }
.btn-full { width:100%; justify-content:center; }
.btn-outline { background:transparent; border:2px solid var(--orange); color:var(--orange); }

/* ===== MODAL ===== */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200;
  display:none; align-items:flex-end; justify-content:center;
  backdrop-filter:blur(4px);
}
.modal-overlay.active { display:flex; }
.modal {
  background:white; border-radius:24px 24px 0 0; width:100%; max-width:500px;
  max-height:92vh; overflow-y:auto; padding:0; animation:slideUp 0.3s ease;
}
.modal::-webkit-scrollbar { display:none; }
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.modal-handle { width:40px; height:4px; background:var(--border); border-radius:2px; margin:12px auto 0; }
.modal-header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; background:white; z-index:1; }
.modal-header h3 { font-family:'Nunito',sans-serif; font-weight:800; font-size:18px; }
.modal-close { width:32px; height:32px; border-radius:8px; border:none; background:var(--card2); cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center; }
.modal-body { padding:20px; }
.modal-footer { padding:16px 20px; border-top:1px solid var(--border); display:flex; gap:10px; position:sticky; bottom:0; background:white; }

/* ===== FORM STYLES ===== */
.form-section { margin-bottom:20px; }
.form-section-title { font-family:'Nunito',sans-serif; font-weight:800; font-size:14px; color:var(--orange); margin-bottom:12px; padding-bottom:6px; border-bottom:2px solid rgba(255,107,0,0.15); text-transform:uppercase; letter-spacing:0.5px; }
.field { margin-bottom:14px; }
.field label { display:block; font-size:12px; font-weight:600; color:var(--text2); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.3px; }
.field input, .field select, .field textarea {
  width:100%; padding:12px 14px; border:1.5px solid var(--border); border-radius:var(--radius3);
  font-size:14px; font-family:'Poppins',sans-serif; color:var(--text); background:white;
  outline:none; transition:all 0.2s; appearance:none; -webkit-appearance:none;
}
.field input:focus, .field select:focus, .field textarea:focus { border-color:var(--orange); box-shadow:0 0 0 3px rgba(255,107,0,0.1); }
.field textarea { resize:vertical; min-height:80px; }
.field-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.field-row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }

/* ===== DUE DATE OPTIONS ===== */
.due-options { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-bottom:10px; }
.due-opt {
  padding:8px 4px; border:1.5px solid var(--border); border-radius:10px;
  text-align:center; font-size:11px; font-weight:600; cursor:pointer;
  transition:all 0.2s; color:var(--text2); background:white;
}
.due-opt.active { background:var(--orange); border-color:var(--orange); color:white; }

/* ===== SERVICE SELECTOR ===== */
.service-chips { display:flex; flex-wrap:wrap; gap:8px; }
.service-chip {
  padding:8px 14px; border:1.5px solid var(--border); border-radius:10px;
  font-size:12px; font-weight:600; cursor:pointer; transition:all 0.2s;
  color:var(--text2); background:white;
}
.service-chip.active { background:rgba(255,107,0,0.1); border-color:var(--orange); color:var(--orange); }

/* ===== ITEMS TABLE ===== */
.items-table { width:100%; border-collapse:collapse; }
.items-table th { background:var(--card2); padding:8px 10px; font-size:11px; font-weight:700; color:var(--text2); text-align:left; text-transform:uppercase; }
.items-table td { padding:8px 10px; border-bottom:1px solid var(--border); font-size:13px; vertical-align:middle; }
.items-table input { width:100%; border:1px solid var(--border); border-radius:6px; padding:5px 8px; font-size:12px; font-family:'Poppins',sans-serif; outline:none; }
.items-table input:focus { border-color:var(--orange); }
.del-row { background:none; border:none; cursor:pointer; color:var(--danger); font-size:16px; padding:4px; }
.add-item-btn { margin-top:8px; width:100%; padding:8px; border:1.5px dashed var(--orange); border-radius:8px; background:rgba(255,107,0,0.05); color:var(--orange); font-size:13px; font-weight:600; cursor:pointer; text-align:center; }

/* ===== PAYMENT SECTION ===== */
.payment-summary { background:linear-gradient(135deg,var(--dark),var(--dark2)); border-radius:var(--radius2); padding:16px; color:white; }
.pay-row { display:flex; justify-content:space-between; align-items:center; padding:5px 0; }
.pay-row span { font-size:13px; opacity:0.8; }
.pay-row strong { font-family:'Nunito',sans-serif; font-weight:800; font-size:15px; }
.pay-divider { border:none; border-top:1px solid rgba(255,255,255,0.15); margin:8px 0; }
.pay-total strong { font-size:20px; color:var(--yellow); }
.pay-balance strong { color:#ff8a80; }

/* ===== DUE DATE PAGE ===== */
.due-section { margin-bottom:16px; }
.due-section-title {
  padding:10px 16px; font-family:'Nunito',sans-serif; font-weight:800; font-size:13px;
  text-transform:uppercase; letter-spacing:0.5px; display:flex; align-items:center; gap:8px;
}
.due-section-title.overdue { color:var(--danger); background:rgba(244,67,54,0.08); }
.due-section-title.today { color:var(--warning); background:rgba(255,179,0,0.08); }
.due-section-title.upcoming { color:var(--success); background:rgba(0,200,83,0.08); }
.due-count { background:currentColor; color:white; border-radius:10px; padding:1px 7px; font-size:11px; }
.due-count-span { background:currentColor; color:white; }

/* ===== CUSTOMER PAGE ===== */
.customer-card {
  background:white; border-radius:var(--radius2); padding:14px 16px; margin:0 16px 8px;
  box-shadow:var(--shadow2); cursor:pointer; display:flex; align-items:center; gap:12px;
  border:1px solid var(--border); transition:all 0.2s;
}
.customer-card:active { transform:scale(0.98); }
.customer-avatar {
  width:44px; height:44px; border-radius:14px; background:linear-gradient(135deg,var(--orange),var(--yellow));
  display:flex; align-items:center; justify-content:center; font-family:'Nunito',sans-serif;
  font-weight:900; font-size:18px; color:white; flex-shrink:0;
}
.customer-info { flex:1; }
.customer-name { font-weight:700; font-size:14px; }
.customer-phone { font-size:12px; color:var(--text2); }
.customer-stats { text-align:right; }
.customer-orders { font-family:'Nunito',sans-serif; font-weight:800; font-size:16px; color:var(--orange); }
.customer-balance { font-size:11px; color:var(--danger); font-weight:600; }

/* ===== REPORTS ===== */
.report-card { background:white; border-radius:var(--radius2); margin:0 16px 12px; padding:16px; box-shadow:var(--shadow2); border:1px solid var(--border); }
.report-card-title { font-family:'Nunito',sans-serif; font-weight:800; font-size:15px; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.report-row { display:flex; justify-content:space-between; padding:7px 0; border-bottom:1px solid var(--border); font-size:13px; }
.report-row:last-child { border-bottom:none; }
.report-val { font-family:'Nunito',sans-serif; font-weight:800; color:var(--orange); }

/* ===== SETTINGS ===== */
.settings-group { background:white; border-radius:var(--radius2); margin:0 16px 12px; overflow:hidden; box-shadow:var(--shadow2); border:1px solid var(--border); }
.settings-group-title { padding:12px 16px; background:var(--card2); font-size:11px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid var(--border); }
.settings-item { padding:14px 16px; display:flex; align-items:center; gap:12px; cursor:pointer; border-bottom:1px solid var(--border); transition:background 0.2s; }
.settings-item:last-child { border-bottom:none; }
.settings-item:active { background:var(--card2); }
.settings-item .s-icon { font-size:20px; width:32px; text-align:center; flex-shrink:0; }
.settings-item .s-info { flex:1; }
.settings-item .s-title { font-size:14px; font-weight:600; }
.settings-item .s-sub { font-size:11px; color:var(--text2); margin-top:1px; }
.settings-item .s-arrow { color:var(--text3); font-size:14px; }
.settings-item .s-badge { background:var(--orange); color:white; font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px; }

/* ===== TOAST ===== */
.toast {
  position:fixed; bottom:calc(var(--bottom-nav) + 16px); left:50%; transform:translateX(-50%) translateY(20px);
  background:var(--dark); color:white; padding:12px 20px; border-radius:12px;
  font-size:13px; font-weight:600; z-index:500; opacity:0; transition:all 0.3s;
  white-space:nowrap; max-width:90vw; text-align:center; pointer-events:none;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
.toast.success { background:var(--success); }
.toast.error { background:var(--danger); }
.toast.warning { background:var(--warning); }

/* ===== POPUP MODAL ===== */
.popup-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:300;
  display:none; align-items:center; justify-content:center; padding:20px;
  backdrop-filter:blur(4px);
}
.popup-overlay.active { display:flex; }
.popup { background:white; border-radius:20px; width:100%; max-width:380px; overflow:hidden; animation:popIn 0.3s ease; }
@keyframes popIn { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
.popup-header { padding:20px 20px 16px; text-align:center; }
.popup-icon { font-size:48px; margin-bottom:8px; }
.popup-title { font-family:'Nunito',sans-serif; font-weight:900; font-size:20px; }
.popup-msg { color:var(--text2); font-size:13px; margin-top:4px; }
.popup-body { padding:0 20px 16px; max-height:300px; overflow-y:auto; }
.popup-footer { padding:16px 20px; border-top:1px solid var(--border); display:flex; gap:10px; }

/* ===== EMPTY STATE ===== */
.empty-state { padding:48px 24px; text-align:center; }
.empty-state .empty-icon { font-size:56px; margin-bottom:12px; opacity:0.4; }
.empty-state h3 { font-family:'Nunito',sans-serif; font-weight:800; font-size:18px; color:var(--text2); }
.empty-state p { font-size:13px; color:var(--text3); margin-top:4px; }

/* ===== INVOICE PREVIEW ===== */
.invoice-preview { background:white; border:1px solid var(--border); border-radius:var(--radius2); padding:20px; font-size:12px; }
.inv-header { text-align:center; margin-bottom:16px; padding-bottom:12px; border-bottom:2px dashed var(--border); }
.inv-header img { height:50px; margin-bottom:8px; }
.inv-header h2 { font-family:'Nunito',sans-serif; font-weight:900; font-size:18px; color:var(--orange); }
.inv-header p { font-size:11px; color:var(--text2); line-height:1.6; }
.inv-row { display:flex; justify-content:space-between; margin-bottom:5px; }
.inv-row span { color:var(--text2); }
.inv-row strong { font-weight:700; }
.inv-divider { border:none; border-top:1px dashed var(--border); margin:10px 0; }
.inv-table { width:100%; border-collapse:collapse; margin:10px 0; }
.inv-table th { background:var(--card2); padding:6px 8px; font-size:10px; font-weight:700; text-align:left; }
.inv-table td { padding:6px 8px; border-bottom:1px solid var(--border); font-size:11px; }
.inv-total { background:var(--dark); color:white; padding:12px; border-radius:8px; margin-top:10px; }
.inv-total-row { display:flex; justify-content:space-between; padding:3px 0; font-size:12px; }
.inv-total-row.main { font-size:16px; font-weight:800; color:var(--yellow); margin-top:4px; }
.inv-footer { text-align:center; margin-top:16px; padding-top:12px; border-top:2px dashed var(--border); }
.inv-footer p { font-size:11px; color:var(--text2); }

/* ===== LOADING ===== */
.loading { display:flex; align-items:center; justify-content:center; padding:40px; }
.spinner { width:32px; height:32px; border:3px solid var(--border); border-top-color:var(--orange); border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }

/* ===== TOGGLE SWITCH ===== */
.toggle { position:relative; display:inline-block; width:44px; height:24px; }
.toggle input { opacity:0; width:0; height:0; }
.toggle-slider { position:absolute; inset:0; background:var(--border); border-radius:24px; cursor:pointer; transition:0.3s; }
.toggle-slider::before { content:''; position:absolute; height:18px; width:18px; left:3px; bottom:3px; background:white; border-radius:50%; transition:0.3s; }
.toggle input:checked + .toggle-slider { background:var(--orange); }
.toggle input:checked + .toggle-slider::before { transform:translateX(20px); }

/* ===== MISC ===== */
.divider { border:none; border-top:1px solid var(--border); margin:12px 0; }
.chip { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:700; }
.chip-orange { background:rgba(255,107,0,0.12); color:var(--orange); }
.chip-green { background:rgba(0,200,83,0.12); color:var(--success); }
.chip-red { background:rgba(244,67,54,0.12); color:var(--danger); }
.chip-blue { background:rgba(33,150,243,0.12); color:var(--info); }
.chip-yellow { background:rgba(255,179,0,0.12); color:var(--warning); }
.chip-purple { background:rgba(124,77,255,0.12); color:var(--purple); }
.text-right { text-align:right; }
.text-center { text-align:center; }
.mt-8 { margin-top:8px; }
.mt-12 { margin-top:12px; }
.mt-16 { margin-top:16px; }
.mb-8 { margin-bottom:8px; }
.flex { display:flex; }
.flex-center { display:flex; align-items:center; justify-content:center; }
.gap-8 { gap:8px; }
.gap-12 { gap:12px; }
.hidden { display:none !important; }
.bold { font-weight:700; }
.orange { color:var(--orange); }
.green { color:var(--success); }
.red { color:var(--danger); }
.gray { color:var(--text3); }
.font-nunito { font-family:'Nunito',sans-serif; font-weight:800; }
.rupee::before { content:'‚Çπ'; }

/* Role specific hiding */
.admin-only { display:none; }
.operator-plus { display:none; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase SDK for cloud sync -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDdn79nK6HBf1PlrWftFnsEtVcYZ07EoxA",
      authDomain: "turbowash-laundry.firebaseapp.com",
      projectId: "turbowash-laundry",
      storageBucket: "turbowash-laundry.firebasestorage.app",
      messagingSenderId: "533027712618",
      appId: "1:533027712618:web:e3013c65f203e62d4d2413"
    };
    
    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
    
    // Enable offline
    firestore.enablePersistence().catch(() => {});
    
    console.log("Firebase ready for cloud sync ‚úÖ");
  </script>
</head>
<body>
<div id="app">

<!-- ===== LOGIN PAGE ===== -->
<div id="loginPage">
  <div class="login-card">
    <div class="login-logo">
      <div style="text-align:center;margin-bottom:4px;">
        <span style="font-family:'Nunito',sans-serif;font-weight:900;font-size:32px;color:#FF6B00;letter-spacing:1px;">Turbo</span><span style="font-family:'Nunito',sans-serif;font-weight:900;font-size:32px;color:#FFD700;letter-spacing:1px;">Wash</span>
        <span style="font-family:'Nunito',sans-serif;font-weight:700;font-size:20px;color:white;display:block;margin-top:-4px;">Laundry</span>
      </div>
    </div>
    <p class="login-tagline">One-stop Solution For All Laundry & Ironing</p>
    <h2 class="login-title">Welcome Back! üëã</h2>
    <p class="login-subtitle">Sign in to manage your laundry business</p>
    <div class="form-group">
      <label>Username</label>
      <input type="text" id="loginUsername" placeholder="Enter username" autocomplete="off">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Enter password">
    </div>
    <button class="btn-login" onclick="doLogin()">
      <span>üîê</span> Sign In
    </button>
    <div class="login-error" id="loginError">Invalid username or password. Please try again.</div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="mainApp" style="display:none; flex-direction:column; height:100vh;">

  <!-- Top Header -->
  <div class="top-header">
    <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#FF6B00,#FFD700);display:flex;align-items:center;justify-content:center;font-family:'Nunito',sans-serif;font-weight:900;font-size:16px;color:white;flex-shrink:0;">TW</div>
    <div class="header-title">
      <h1>TurboWash Laundry</h1>
      <p id="headerUserInfo">Loading...</p>
    </div>
    <button onclick="manualSync()" style="padding:8px 12px;border-radius:8px;border:1.5px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:white;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;" id="syncBtn">
      <span id="syncIcon">üîÑ</span> <span id="syncText">Sync</span>
    </button>
    <div class="header-actions">
      <button class="header-btn" onclick="showNotifications()" id="notifBtn">
        üîî<span class="badge hidden" id="notifBadge">0</span>
      </button>
      <button class="header-btn" onclick="showUserMenu()">üë§</button>
    </div>
  </div>

  <!-- Pages Container -->
  <div style="flex:1; overflow:hidden; position:relative;">

    <!-- DASHBOARD PAGE -->
    <div class="page active" id="pageDashboard">
      <div class="page-content">
        <div class="dash-greeting">
          <h2 id="dashGreeting">Good Morning! ‚òÄÔ∏è</h2>
          <p id="dashDate">Today is loading...</p>
        </div>
        <!-- Overdue Banner -->
        <div class="overdue-banner hidden" id="overdueBanner" onclick="switchPage('pageDueDate')">
          <span class="icon">üö®</span>
          <div class="text">
            <b id="overdueText">3 orders are overdue!</b>
            <span>Tap to view overdue orders</span>
          </div>
          <span class="arrow">‚Ä∫</span>
        </div>
        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card orange">
            <div class="stat-icon">üì¶</div>
            <div class="stat-val" id="statToday">0</div>
            <div class="stat-lbl">Today's Orders</div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-val" id="statPending">0</div>
            <div class="stat-lbl">Pending Orders</div>
          </div>
          <div class="stat-card green">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-val" id="statReady">0</div>
            <div class="stat-lbl">Ready for Pickup</div>
          </div>
          <div class="stat-card red">
            <div class="stat-icon">üö®</div>
            <div class="stat-val" id="statOverdue">0</div>
            <div class="stat-lbl">Overdue Orders</div>
          </div>
          <!-- Admin only stats -->
          <div class="stat-card blue admin-only" id="statRevenueCard">
            <div class="stat-icon">üí∞</div>
            <div class="stat-val" id="statRevenue">‚Çπ0</div>
            <div class="stat-lbl">Revenue (30 days)</div>
          </div>
          <div class="stat-card purple admin-only" id="statUnpaidCard">
            <div class="stat-icon">üí∏</div>
            <div class="stat-val" id="statUnpaid">0</div>
            <div class="stat-lbl">Unpaid Orders</div>
          </div>
        </div>
        <!-- Recent Orders -->
        <div class="section-header">
          <h3>Recent Orders</h3>
          <a onclick="switchPage('pageOrders')">View All ‚Ä∫</a>
        </div>
        <div class="recent-orders" id="recentOrdersList">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- ORDERS PAGE -->
    <div class="page" id="pageOrders">
      <div class="page-content">
        <div class="search-bar">
          <div class="search-input-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="Search by name, phone or order no..." id="orderSearch" oninput="filterOrders()">
          </div>
        </div>
        <div class="filter-tabs" id="orderFilterTabs">
          <div class="filter-tab active" onclick="setOrderFilter('all',this)">All</div>
          <div class="filter-tab" onclick="setOrderFilter('received',this)">Received</div>
          <div class="filter-tab" onclick="setOrderFilter('inprogress',this)">In Progress</div>
          <div class="filter-tab" onclick="setOrderFilter('ready',this)">Ready</div>
          <div class="filter-tab" onclick="setOrderFilter('delivered',this)">Delivered</div>
          <div class="filter-tab" onclick="setOrderFilter('cancelled',this)">Cancelled</div>
        </div>
        <div id="ordersList" style="padding:0 16px; display:flex; flex-direction:column; gap:8px; padding-bottom:20px;">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- DUE DATE PAGE -->
    <div class="page" id="pageDueDate">
      <div class="page-content" id="dueDateContent">
        <div class="loading" style="padding:40px;"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- CUSTOMERS PAGE -->
    <div class="page" id="pageCustomers">
      <div class="page-content">
        <div class="search-bar">
          <div class="search-input-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="Search customers..." id="customerSearch" oninput="filterCustomers()">
          </div>
        </div>
        <div id="customersList">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- MORE PAGE (Reports, Settings, Backup) -->
    <div class="page" id="pageMore">
      <div class="page-content" style="padding-top:12px;">
        <!-- Admin sections -->
        <div id="adminMoreSection">
          <div class="settings-group">
            <div class="settings-group-title">üìä Reports & Analytics</div>
            <div class="settings-item" onclick="showReports()">
              <span class="s-icon">üìà</span>
              <div class="s-info"><div class="s-title">Business Reports</div><div class="s-sub">Revenue, orders, service analysis</div></div>
              <span class="s-arrow">‚Ä∫</span>
            </div>
            <div class="settings-item" onclick="showPendingPayments()">
              <span class="s-icon">üí∏</span>
              <div class="s-info"><div class="s-title">Pending Payments</div><div class="s-sub">Outstanding dues & collections</div></div>
              <span class="s-arrow">‚Ä∫</span>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">‚öôÔ∏è Business Settings</div>
            <div class="settings-item" onclick="showServicesManager()">
              <span class="s-icon">üß∫</span>
              <div class="s-info"><div class="s-title">Services & Pricing</div><div class="s-sub">Manage services, items & prices</div></div>
              <span class="s-arrow">‚Ä∫</span>
            </div>
            <div class="settings-item" onclick="resetServicesToDefault()">
              <span class="s-icon">üîÑ</span>
              <div class="s-info"><div class="s-title">Reset Services to Default</div><div class="s-sub">Reload all services & prices</div></div>
              <span class="s-arrow">‚Ä∫</span>
            </div>
            <div class="settings-item" onclick="showWhatsAppTemplates()">
              <span class="s-icon">üí¨</span>
              <div class="s-info"><div class="s-title">WhatsApp Templates</div><div class="s-sub">Edit message templates</div></div>
              <span class="s-arrow">‚Ä∫</span>
            </div>
            <div class="settings-item" onclick="showShopSettings()">
              <span class="s-icon">üè™</span>
              <div class="s-info"><div class="s-title">Shop Settings</div><div class="s-sub">Name, address, phone, hours</div></div>
              <span class="s-arrow">‚Ä∫</span>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">üë• User Management</div>
            <div class="settings-item" onclick="showUserManager()">
              <span class="s-icon">üë§</span>
              <div class="s-info"><div class="s-title">Manage Users</div><div class="s-sub">Add, edit, reset passwords</div></div>
              <span class="s-arrow">‚Ä∫</span>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">üíæ Backup & Data</div>
            <div class="settings-item" onclick="exportData()">
              <span class="s-icon">üì§</span>
              <div class="s-info"><div class="s-title">Export Backup</div><div class="s-sub" id="lastBackupText">Last backup: Never</div></div>
              <span class="s-arrow">‚Ä∫</span>
            </div>
            <div class="settings-item" onclick="importData()">
              <span class="s-icon">üì•</span>
              <div class="s-info"><div class="s-title">Import Data</div><div class="s-sub">Restore from backup file</div></div>
              <span class="s-arrow">‚Ä∫</span>
            </div>
            <div class="settings-item" onclick="resetAllData()" style="border-top:2px solid var(--danger);">
              <span class="s-icon" style="color:var(--danger);">üóëÔ∏è</span>
              <div class="s-info"><div class="s-title" style="color:var(--danger);">Reset All Data</div><div class="s-sub">‚ö†Ô∏è Delete everything - cannot be undone</div></div>
              <span class="s-arrow" style="color:var(--danger);">‚Ä∫</span>
            </div>
          </div>
        </div>
        <!-- All users -->
        <div class="settings-group">
          <div class="settings-group-title">üë§ Account</div>
          <div class="settings-item" onclick="showChangePassword()">
            <span class="s-icon">üîë</span>
            <div class="s-info"><div class="s-title">Change Password</div><div class="s-sub">Update your password</div></div>
            <span class="s-arrow">‚Ä∫</span>
          </div>
          <div class="settings-item" onclick="doLogout()">
            <span class="s-icon">üö™</span>
            <div class="s-info"><div class="s-title">Logout</div><div class="s-sub" id="loggedInAs">Logged in as Admin</div></div>
            <span class="s-arrow">‚Ä∫</span>
          </div>
        </div>
        <div style="text-align:center; padding:16px; color:var(--text3); font-size:11px;">
          TurboWash Laundry v1.0 | Made with ‚ù§Ô∏è
        </div>
      </div>
    </div>

  </div><!-- end pages container -->

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('pageDashboard')" id="nav-pageDashboard">
      <span class="nav-icon">üè†</span>
      <span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="switchPage('pageOrders')" id="nav-pageOrders">
      <span class="nav-icon">üìã</span>
      <span class="nav-label">Orders</span>
    </button>
    <button class="nav-fab" onclick="showNewOrderModal()" id="fabBtn">Ôºã</button>
    <button class="nav-item" onclick="switchPage('pageDueDate')" id="nav-pageDueDate">
      <span class="nav-icon">üìÖ</span>
      <span class="nav-label">Due Date</span>
    </button>
    <button class="nav-item" onclick="switchPage('pageMore')" id="nav-pageMore">
      <span class="nav-icon">‚ò∞</span>
      <span class="nav-label">More</span>
    </button>
  </div>

</div><!-- end mainApp -->

<!-- ===== MODALS ===== -->

<!-- New/Edit Order Modal -->
<div class="modal-overlay" id="orderModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h3 id="orderModalTitle">New Order</h3>
      <button class="modal-close" onclick="closeModal('orderModal')">‚úï</button>
    </div>
    <div class="modal-body" id="orderModalBody">
      <!-- Dynamically filled -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('orderModal')">Cancel</button>
      <button class="btn btn-primary" style="flex:2" onclick="saveOrder()" id="saveOrderBtn">üíæ Save Order</button>
    </div>
  </div>
</div>

<!-- Order Detail Modal -->
<div class="modal-overlay" id="orderDetailModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h3 id="orderDetailTitle">Order Details</h3>
      <button class="modal-close" onclick="closeModal('orderDetailModal')">‚úï</button>
    </div>
    <div class="modal-body" id="orderDetailBody"></div>
    <div class="modal-footer" id="orderDetailFooter"></div>
  </div>
</div>

<!-- Invoice Modal -->
<div class="modal-overlay" id="invoiceModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h3>Invoice Preview</h3>
      <button class="modal-close" onclick="closeModal('invoiceModal')">‚úï</button>
    </div>
    <div class="modal-body" id="invoiceBody"></div>
    <div class="modal-footer" style="flex-wrap:wrap;gap:8px;">
      <button class="btn btn-secondary btn-sm" style="flex:1" onclick="closeModal('invoiceModal')">‚úï Close</button>
      <button class="btn btn-success btn-sm" style="flex:1.5" onclick="shareInvoiceAsImage()">üì± Share Status</button>
      <button class="btn btn-primary btn-sm" style="flex:1" onclick="downloadInvoicePDF()">‚¨áÔ∏è Download PDF</button>
    </div>
  </div>
</div>

<!-- Generic Popup -->
<div class="popup-overlay" id="genericPopup">
  <div class="popup">
    <div class="popup-header">
      <div class="popup-icon" id="popupIcon">‚ÑπÔ∏è</div>
      <div class="popup-title" id="popupTitle">Title</div>
      <div class="popup-msg" id="popupMsg">Message</div>
    </div>
    <div class="popup-body" id="popupBody"></div>
    <div class="popup-footer" id="popupFooter">
      <button class="btn btn-primary btn-full" onclick="closePopup()">OK</button>
    </div>
  </div>
</div>

<!-- User Menu Modal -->
<div class="modal-overlay" id="userMenuModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h3>Account</h3>
      <button class="modal-close" onclick="closeModal('userMenuModal')">‚úï</button>
    </div>
    <div class="modal-body" id="userMenuBody"></div>
  </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="importFileInput" accept=".json" style="display:none" onchange="processImport(event)">

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Print styles -->
<style>
@media print {
  body > *:not(#printArea) { display:none !important; }
  #printArea { display:block !important; padding:20px; }
}
</style>
<div id="printArea" style="display:none;"></div>

<!-- ===== CUSTOMER TRACKING PAGE ===== -->
<div id="trackingPage" style="display:none;position:fixed;inset:0;background:#f0f2f8;z-index:500;overflow-y:auto;">
  <div style="max-width:500px;margin:0 auto;min-height:100vh;background:white;">
    <!-- Header -->
    <div style="background:linear-gradient(135deg,#1A1A2E,#0F3460);padding:20px;text-align:center;position:sticky;top:0;z-index:10;box-shadow:0 4px 15px rgba(0,0,0,0.2);">
      <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px;">
        <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#FF6B00,#FFD700);display:flex;align-items:center;justify-content:center;font-family:'Nunito',sans-serif;font-weight:900;font-size:18px;color:white;">TW</div>
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:22px;color:white;">TurboWash</div>
      </div>
      <div style="font-size:12px;color:rgba(255,255,255,0.7);">Order Tracking</div>
    </div>
    
    <!-- Content -->
    <div id="trackingContent" style="padding:20px;">
      <div class="loading"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA STORE
// ============================================================
const DB = {
  get(key) { try { return JSON.parse(localStorage.getItem('twl_'+key)); } catch(e){ return null; } },
  set(key, val) { localStorage.setItem('twl_'+key, JSON.stringify(val)); },
  del(key) { localStorage.removeItem('twl_'+key); }
};

// ============================================================
// FIREBASE CLOUD SYNC (Background)
// ============================================================
function syncToCloud(key, value) {
  if (typeof firebase === 'undefined') return;
  setTimeout(async () => {
    try {
      await firestore.collection('appData').doc(key).set({
        data: value,
        updated: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log('‚úÖ Synced to cloud:', key);
    } catch(e) { 
      console.error('Sync failed:', key, e);
    }
  }, 100);
}

// Manual sync button function
async function manualSync() {
  const btn = document.getElementById('syncBtn');
  const icon = document.getElementById('syncIcon');
  const text = document.getElementById('syncText');
  
  if (typeof firebase === 'undefined') {
    showToast('Firebase not initialized', 'error');
    return;
  }
  
  btn.disabled = true;
  icon.textContent = '‚è≥';
  text.textContent = 'Syncing...';
  
  try {
    console.log('üîÑ Starting sync...');
    
    // STEP 1: First PULL from cloud to get latest data
    const snapshot = await firestore.collection('appData').get();
    let cloudOrders = [];
    let cloudCustomers = [];
    let cloudServices = null;
    let cloudUsers = null;
    let cloudSettings = null;
    let cloudCounter = 0;
    let cloudTemplates = null;
    
    snapshot.forEach(doc => {
      const docData = doc.data();
      if (docData && docData.data) {
        if (doc.id === 'orders') cloudOrders = docData.data || [];
        if (doc.id === 'customers') cloudCustomers = docData.data || [];
        if (doc.id === 'services') cloudServices = docData.data;
        if (doc.id === 'users') cloudUsers = docData.data;
        if (doc.id === 'shopSettings') cloudSettings = docData.data;
        if (doc.id === 'orderCounter') cloudCounter = docData.data || 0;
        if (doc.id === 'whatsappTemplates') cloudTemplates = docData.data;
      }
    });
    
    console.log('üì• Pulled from cloud:', cloudOrders.length, 'orders,', cloudCustomers.length, 'customers');
    
    // STEP 2: Merge local with cloud data
    const localOrders = DB.get('orders') || [];
    const localCustomers = DB.get('customers') || [];
    
    // Create merged orders (cloud + local, deduplicated by ID)
    const mergedOrders = [...cloudOrders];
    localOrders.forEach(localOrder => {
      const existingIndex = mergedOrders.findIndex(o => o.id === localOrder.id);
      if (existingIndex === -1) {
        // New local order not in cloud - add it
        mergedOrders.push(localOrder);
      } else {
        // Order exists in both - keep the one with latest timestamp
        const cloudOrder = mergedOrders[existingIndex];
        const localTime = localOrder.createdAt || 0;
        const cloudTime = cloudOrder.createdAt || 0;
        if (localTime > cloudTime) {
          mergedOrders[existingIndex] = localOrder;
        }
      }
    });
    
    // Create merged customers (cloud + local, deduplicated by ID)
    const mergedCustomers = [...cloudCustomers];
    localCustomers.forEach(localCustomer => {
      const existingIndex = mergedCustomers.findIndex(c => c.id === localCustomer.id);
      if (existingIndex === -1) {
        // New local customer not in cloud - add it
        mergedCustomers.push(localCustomer);
      } else {
        // Customer exists in both - keep the one with latest timestamp
        const cloudCustomer = mergedCustomers[existingIndex];
        const localTime = localCustomer.createdAt || 0;
        const cloudTime = cloudCustomer.createdAt || 0;
        if (localTime > cloudTime) {
          mergedCustomers[existingIndex] = localCustomer;
        }
      }
    });
    
    console.log('üîÄ Merged data:', mergedOrders.length, 'orders,', mergedCustomers.length, 'customers');
    
    // STEP 3: Push merged data back to cloud
    await firestore.collection('appData').doc('orders').set({
      data: mergedOrders,
      updated: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    await firestore.collection('appData').doc('customers').set({
      data: mergedCustomers,
      updated: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Push other data (these don't need merging, just sync latest)
    const localServices = DB.get('services');
    if (localServices) {
      await firestore.collection('appData').doc('services').set({
        data: localServices,
        updated: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    const localUsers = DB.get('users');
    if (localUsers) {
      await firestore.collection('appData').doc('users').set({
        data: localUsers,
        updated: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    const localSettings = DB.get('shopSettings');
    if (localSettings) {
      await firestore.collection('appData').doc('shopSettings').set({
        data: localSettings,
        updated: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    const localCounter = DB.get('orderCounter') || 0;
    const maxCounter = Math.max(localCounter, cloudCounter);
    await firestore.collection('appData').doc('orderCounter').set({
      data: maxCounter,
      updated: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    const localTemplates = DB.get('whatsappTemplates');
    if (localTemplates) {
      await firestore.collection('appData').doc('whatsappTemplates').set({
        data: localTemplates,
        updated: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    console.log('üì§ Pushed merged data to cloud');
    
    // STEP 4: Save merged data to local storage
    DB.set('orders', mergedOrders);
    DB.set('customers', mergedCustomers);
    if (cloudServices) DB.set('services', cloudServices);
    if (cloudUsers) DB.set('users', cloudUsers);
    if (cloudSettings) DB.set('shopSettings', cloudSettings);
    if (maxCounter) DB.set('orderCounter', maxCounter);
    if (cloudTemplates) DB.set('whatsappTemplates', cloudTemplates);
    
    console.log('üíæ Saved merged data to local storage');
    
    // STEP 5: Refresh UI
    if (typeof renderOrders === 'function') renderOrders();
    if (typeof renderDueDatePage === 'function') renderDueDatePage();
    if (typeof refreshDashboard === 'function') refreshDashboard();
    if (typeof renderCustomers === 'function') renderCustomers();
    
    icon.textContent = '‚úÖ';
    text.textContent = 'Synced!';
    showToast(`Sync complete! ${mergedOrders.length} orders, ${mergedCustomers.length} customers`, 'success');
    
    setTimeout(() => {
      icon.textContent = 'üîÑ';
      text.textContent = 'Sync';
      btn.disabled = false;
    }, 2000);
    
  } catch(err) {
    console.error('Manual sync error:', err);
    icon.textContent = '‚ùå';
    text.textContent = 'Failed';
    showToast('Sync failed: ' + err.message, 'error');
    
    setTimeout(() => {
      icon.textContent = 'üîÑ';
      text.textContent = 'Sync';
      btn.disabled = false;
    }, 2000);
  }
}

// Auto-sync on data changes
const originalDBSet = DB.set;
DB.set = function(key, val) {
  const result = originalDBSet(key, val);
  syncToCloud(key, val);
  return result;
};

// Pull from cloud on startup
async function pullFromCloud() {
  if (typeof firebase === 'undefined') return;
  try {
    console.log('üîÑ Auto-syncing on startup...');
    const snapshot = await firestore.collection('appData').get();
    let cloudOrders = [];
    let cloudCustomers = [];
    
    snapshot.forEach(doc => {
      const docData = doc.data();
      if (docData && docData.data) {
        const key = doc.id;
        
        // For orders and customers, merge with local
        if (key === 'orders') {
          cloudOrders = docData.data || [];
          const localOrders = DB.get('orders') || [];
          const merged = [...cloudOrders];
          
          localOrders.forEach(localOrder => {
            if (!merged.find(o => o.id === localOrder.id)) {
              merged.push(localOrder);
            }
          });
          
          DB.set('orders', merged);
          console.log('‚úÖ Merged orders:', merged.length);
        } else if (key === 'customers') {
          cloudCustomers = docData.data || [];
          const localCustomers = DB.get('customers') || [];
          const merged = [...cloudCustomers];
          
          localCustomers.forEach(localCustomer => {
            if (!merged.find(c => c.id === localCustomer.id)) {
              merged.push(localCustomer);
            }
          });
          
          DB.set('customers', merged);
          console.log('‚úÖ Merged customers:', merged.length);
        } else {
          // For other data, use cloud if local doesn't exist
          const local = DB.get(key);
          if (!local && docData.data) {
            DB.set(key, docData.data);
            console.log('‚úÖ Loaded', key, 'from cloud');
          }
        }
      }
    });
    
    // Refresh UI
    if (typeof renderOrders === 'function') renderOrders();
    if (typeof renderDueDatePage === 'function') renderDueDatePage();
    if (typeof refreshDashboard === 'function') refreshDashboard();
    if (typeof renderCustomers === 'function') renderCustomers();
    
  } catch(e) { 
    console.error('Pull error:', e);
  }
}

// Listen for changes from other devices
let syncTimeout;
if (typeof firebase !== 'undefined') {
  // Wait for app to load before starting listener
  setTimeout(() => {
    firestore.collection('appData').onSnapshot((snapshot) => {
      clearTimeout(syncTimeout);
      syncTimeout = setTimeout(() => {
        let needsRefresh = false;
        
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'modified' || change.type === 'added') {
            const key = change.doc.id;
            const cloudData = change.doc.data().data;
            const localData = DB.get(key);
            
            // Update if different or doesn't exist locally
            const cloudStr = JSON.stringify(cloudData);
            const localStr = JSON.stringify(localData);
            
            if (cloudStr !== localStr) {
              // For orders and customers, merge instead of replace
              if (key === 'orders' || key === 'customers') {
                const merged = [...(cloudData || [])];
                const local = localData || [];
                
                local.forEach(localItem => {
                  if (!merged.find(item => item.id === localItem.id)) {
                    merged.push(localItem);
                  }
                });
                
                DB.set(key, merged);
                console.log('üîÑ Merged from cloud:', key, merged.length, 'items');
              } else {
                DB.set(key, cloudData);
                console.log('üîÑ Synced from cloud:', key);
              }
              
              if (['orders', 'customers', 'services'].includes(key)) {
                needsRefresh = true;
              }
            }
          }
        });
        
        // Refresh UI
        if (needsRefresh) {
          if (typeof renderOrders === 'function') renderOrders();
          if (typeof renderDueDatePage === 'function') renderDueDatePage();
          if (typeof refreshDashboard === 'function') refreshDashboard();
          if (typeof renderCustomers === 'function') renderCustomers();
          showToast('Data updated from cloud üîÑ', 'info');
        }
      }, 1000);
    }, (error) => {
      console.error('Listener error:', error);
    });
  }, 3000); // Wait 3 seconds after login
}


// ============================================================
// INITIAL DATA SETUP
// ============================================================
function initApp() {
  // Setup default users if none exist
  if (!DB.get('users')) {
    DB.set('users', [
      { id:'u1', username:'admin', password:'admin123', name:'Admin User', role:'admin', active:true, createdAt: new Date().toISOString() },
      { id:'u2', username:'operator', password:'op123', name:'Operator User', role:'operator', active:true, createdAt: new Date().toISOString() },
      { id:'u3', username:'viewer', password:'view123', name:'Viewer User', role:'viewer', active:true, createdAt: new Date().toISOString() }
    ]);
  }
  if (!DB.get('orders')) DB.set('orders', []);
  if (!DB.get('customers')) DB.set('customers', []);
  if (!DB.get('orderCounter')) DB.set('orderCounter', 0);

  if (!DB.get('services')) {
    DB.set('services', [
      { id:'s1', name:'Dry Cleaning', icon:'üëî', active:true, pricingType:'per_item', items:[
        {name:'Shirt / T-Shirt (Cotton / Formal)', price:70},
        {name:'Pant / Trouser / Jeans (Formal / Cotton)', price:70},
        {name:'Kurta (Ethnic / Cotton)', price:100},
        {name:'Blazer (Dry clean recommended)', price:250},
        {name:'2 Piece (Blazer + Pant)', price:300},
        {name:'3 Piece (Blazer + Pant + Waistcoat)', price:380},
        {name:'Jacket (Light / Heavy)', price:150},
        {name:'Sweater (Knitted / Wool Blend)', price:200},
        {name:'Blouse (Cotton)', price:40},
        {name:'Blouse (Designer)', price:80},
        {name:'Kurti (Casual)', price:70},
        {name:'Kurti (Formal / Fancy)', price:150},
        {name:'Pyjama (Cotton)', price:70},
        {name:'Pyjama (Silk)', price:140},
        {name:'Dress (Kurta, Pyjama, Odhni)', price:150},
        {name:'One Piece (Western / Party Wear)', price:200},
        {name:'Lehenga (Bridal / Heavy Embroidery)', price:400},
        {name:'Bedsheet (Cotton / Printed) - Single', price:70},
        {name:'Bedsheet (Cotton / Printed) - Double', price:130},
        {name:'Curtain (Per Piece - Normal) - Single', price:250},
        {name:'Curtain (Per Piece - Normal) - Double', price:400},
        {name:'Pillow Cover (Per Piece) - Single', price:40},
        {name:'Pillow Cover (Per Piece) - Double', price:80},
        {name:'Quilt / Comforter - Single', price:200},
        {name:'Quilt / Comforter - Double', price:350},
        {name:'Blanket (Light)', price:150},
        {name:'Blanket (Heavy)', price:275},
        {name:'Sofa Cover (Per Seat) - Single', price:90},
        {name:'Sofa Cover (Per Seat) - Double', price:150}
      ]},
      { id:'s2', name:'Wash & Fold', icon:'üß∫', active:true, pricingType:'per_kg', items:[
        {name:'Wash & Fold', price:80}
      ]},
      { id:'s3', name:'Wash & Iron', icon:'üëï', active:true, pricingType:'per_kg', items:[
        {name:'Wash & Iron', price:110}
      ]},
      { id:'s4', name:'Steam Ironing', icon:'‚ô®Ô∏è', active:true, pricingType:'per_item', items:[
        {name:'Shirt / T-Shirt (Cotton / Formal)', price:20},
        {name:'Pant / Trouser / Jeans (Formal / Cotton)', price:20},
        {name:'Kurta (Ethnic / Cotton)', price:30},
        {name:'Blazer (Dry clean recommended)', price:70},
        {name:'2 Piece (Blazer + Pant)', price:80},
        {name:'3 Piece (Blazer + Pant + Waistcoat)', price:120},
        {name:'Jacket (Light / Heavy)', price:30},
        {name:'Sweater (Knitted / Wool Blend)', price:70},
        {name:'Blouse (Cotton / Designer)', price:20},
        {name:'Kurti (Casual)', price:20},
        {name:'Kurti (Formal / Fancy)', price:50},
        {name:'Pyjama (Cotton)', price:20},
        {name:'Pyjama (Silk)', price:40},
        {name:'Dress (Kurta, Pyjama, Odhni)', price:60},
        {name:'One Piece (Western / Party Wear)', price:80},
        {name:'Lehenga (Bridal / Heavy Embroidery)', price:150}
      ]},
      { id:'s5', name:'Shoe Cleaning', icon:'üëü', active:true, pricingType:'per_item', items:[
        {name:'Sports Shoes (Running / Gym)', price:250},
        {name:'Leather Shoes (Formal / Office)', price:280}
      ]},
      { id:'s6', name:'Saree Roll Press', icon:'ü•ª', active:true, pricingType:'per_item', items:[
        {name:'Saree Roll Press', price:60}
      ]},
      { id:'s7', name:'Dying', icon:'üé®', active:true, pricingType:'per_item', items:[
        {name:'Shirt', price:250},
        {name:'Pant', price:250}
      ]},
      { id:'s8', name:'Normal Iron', icon:'üî≤', active:true, pricingType:'per_item', items:[] }
    ]);
  }

  if (!DB.get('shopSettings')) {
    DB.set('shopSettings', {
      name: 'TurboWash Laundry',
      address: 'Shop no. 2, Newale House, Power House Road, Near Ashok Theatre, Pimprigaon, Pune 411017',
      phone: '+91-9011637090',
      hours: '9AM - 9PM',
      orderPrefix: 'TWL'
    });
  }

  if (!DB.get('shareCounts')) DB.set('shareCounts', {});
  if (!DB.get('whatsappTemplates')) {
    DB.set('whatsappTemplates', {
      orderReceived: `Dear {customerName},

Your order has been received! üß∫

Order No: {orderNo}
Services: {services}
Total Amount: ‚Çπ{totalAmount}
Advance Paid: ‚Çπ{advancePaid}
Balance Due: ‚Çπ{balanceDue}

Expected Delivery: {dueDate}

Thank you for choosing TurboWash Laundry!
üìû +91-9011637090
üïê 9AM - 9PM`,
      orderReady: `Dear {customerName},

Your order {orderNo} is ready for pickup! ‚úÖüéâ

Please collect at your earliest convenience.

Balance Due: ‚Çπ{balanceDue}

Thank you for choosing TurboWash Laundry!
üìû +91-9011637090`
    });
  }

  // Logo removed - embedLogo kept for future use
  embedLogo();

  // Check if already logged in
  const session = DB.get('session');
  if (session) {
    const users = DB.get('users') || [];
    const user = users.find(u => u.id === session.userId && u.active);
    if (user) {
      currentUser = user;
      showMainApp();
      return;
    }
  }
  document.getElementById('loginPage').style.display = 'flex';
}

function getLogo() {
  return null; // Logo removed - will be added in future
}

// ============================================================
// CURRENT USER & SESSION
// ============================================================
let currentUser = null;
let currentOrderFilter = 'all';
let editingOrderId = null;
let currentInvoiceOrderId = null;
let dueDateRefreshInterval = null;

function doLogin() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  const err = document.getElementById('loginError');
  err.style.display = 'none';

  if (!username || !password) { err.textContent = 'Please enter username and password.'; err.style.display = 'block'; return; }

  const users = DB.get('users') || [];
  const user = users.find(u => u.username === username && u.password === password && u.active);

  if (!user) { err.textContent = 'Invalid username or password. Please try again.'; err.style.display = 'block'; return; }

  currentUser = user;
  DB.set('session', { userId: user.id, loginAt: new Date().toISOString() });
  showMainApp();
}

document.getElementById('loginPassword').addEventListener('keypress', e => { if(e.key==='Enter') doLogin(); });
document.getElementById('loginUsername').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('loginPassword').focus(); });

function showMainApp() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('mainApp').style.display = 'flex';

  // Set role-based UI
  applyRoleUI();
  updateHeaderInfo();
  refreshDashboard();
  renderOrders();
  renderCustomers();

  // Start due date auto-refresh
  renderDueDatePage();
  if (dueDateRefreshInterval) clearInterval(dueDateRefreshInterval);
  dueDateRefreshInterval = setInterval(() => {
    renderDueDatePage();
    refreshDashboard();
    checkOverduePopup();
  }, 60000);

  checkOverduePopup();
  updateLastBackup();
  
  // Auto-sync from cloud on login
  if (typeof firebase !== 'undefined') {
    setTimeout(() => {
      console.log('üîÑ Auto-syncing from cloud...');
      manualSync();
    }, 2000);
  }
  
  // Check if this is a tracking URL
  checkTrackingURL();
}

// ============================================================
// CUSTOMER TRACKING PAGE
// ============================================================
function checkTrackingURL() {
  const path = window.location.pathname;
  const match = path.match(/\/track\/([A-Z]+-\d+)/i);
  if (match) {
    const orderNo = match[1].toUpperCase();
    showTrackingPage(orderNo);
  }
}

function showTrackingPage(orderNo) {
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('trackingPage').style.display = 'block';
  
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.orderNo === orderNo);
  
  const content = document.getElementById('trackingContent');
  
  if (!order) {
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üîç</div>
        <h3>Order Not Found</h3>
        <p>We couldn't find order <strong>${orderNo}</strong></p>
        <p style="margin-top:12px;font-size:13px;color:var(--text3);">Please check the order number and try again.</p>
      </div>`;
    return;
  }
  
  const balance = Math.max(0, (order.totalAmount||0) - (order.paidAmount||0));
  const shop = DB.get('shopSettings') || {};
  
  // Status timeline
  const statuses = ['received','inprogress','ready','delivered'];
  const statusLabels = {received:'Order Received',inprogress:'In Progress',ready:'Ready for Pickup',delivered:'Delivered'};
  const statusIcons = {received:'üì¶',inprogress:'‚è≥',ready:'‚úÖ',delivered:'üéâ'};
  
  const currentIndex = statuses.indexOf(order.status);
  
  content.innerHTML = `
    <!-- Order Header -->
    <div style="background:linear-gradient(135deg,var(--orange),var(--yellow));border-radius:16px;padding:20px;color:white;margin-bottom:20px;box-shadow:0 8px 25px rgba(255,107,0,0.3);">
      <div style="font-size:13px;opacity:0.85;margin-bottom:4px;">Order Number</div>
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:28px;">${order.orderNo}</div>
      <div style="font-size:14px;margin-top:8px;">üë§ ${order.customerName}</div>
      <div style="font-size:13px;opacity:0.85;margin-top:4px;">üìÖ Due: ${formatDate(order.dueDate)}</div>
    </div>
    
    <!-- Status Timeline -->
    <div style="background:white;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.08);">
      <div style="font-weight:700;font-size:14px;color:var(--text2);margin-bottom:16px;text-transform:uppercase;letter-spacing:0.5px;">Order Status</div>
      ${statuses.map((s,i) => {
        const isDone = i <= currentIndex;
        const isCurrent = i === currentIndex;
        const statusEntry = (order.statusHistory||[]).find(h => h.status === s);
        return `<div style="display:flex;gap:12px;margin-bottom:${i<statuses.length-1?'16px':'0'};">
          <div style="flex-shrink:0;display:flex;flex-direction:column;align-items:center;">
            <div style="width:40px;height:40px;border-radius:50%;background:${isDone?'linear-gradient(135deg,var(--orange),var(--yellow))':' var(--border)'};display:flex;align-items:center;justify-content:center;font-size:18px;${isCurrent?'box-shadow:0 4px 15px rgba(255,107,0,0.4);transform:scale(1.1);':''}">
              ${isDone?statusIcons[s]:'‚è≥'}
            </div>
            ${i<statuses.length-1?`<div style="width:2px;height:24px;background:${isDone?'var(--orange)':'var(--border)'};margin:4px 0;"></div>`:''}
          </div>
          <div style="flex:1;padding-top:4px;">
            <div style="font-weight:700;font-size:14px;color:${isDone?'var(--text)':'var(--text3)'};">${statusLabels[s]}</div>
            ${statusEntry?`<div style="font-size:11px;color:var(--text3);margin-top:2px;">${formatDateTime(statusEntry.changedAt)}</div>`:`<div style="font-size:11px;color:var(--text3);margin-top:2px;">Pending</div>`}
          </div>
        </div>`;
      }).join('')}
    </div>
    
    <!-- Payment Info -->
    <div style="background:var(--dark);border-radius:16px;padding:18px;margin-bottom:20px;color:white;">
      <div style="font-weight:700;font-size:12px;opacity:0.6;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px;">Payment Details</div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
        <span style="font-size:14px;opacity:0.8;">Total Amount</span>
        <strong style="font-family:'Nunito',sans-serif;font-size:16px;">‚Çπ${(order.totalAmount||0).toFixed(0)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
        <span style="font-size:14px;opacity:0.8;">Paid</span>
        <strong style="font-family:'Nunito',sans-serif;font-size:16px;color:#69f0ae;">‚Çπ${(order.paidAmount||0).toFixed(0)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;">
        <span style="font-size:14px;opacity:0.8;">Balance Due</span>
        <strong style="font-family:'Nunito',sans-serif;font-size:18px;color:${balance>0?'#ff8a80':'#69f0ae'};">‚Çπ${balance.toFixed(0)}</strong>
      </div>
    </div>
    
    <!-- Shop Info -->
    <div style="background:rgba(255,107,0,0.08);border-radius:16px;padding:18px;margin-bottom:20px;border:1.5px dashed var(--orange);">
      <div style="font-weight:700;font-size:14px;color:var(--orange);margin-bottom:12px;">üìç ${shop.name||'TurboWash Laundry'}</div>
      <div style="font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:8px;">${shop.address||''}</div>
      <div style="font-size:13px;color:var(--text2);">üìû ${shop.phone||''}</div>
      <div style="font-size:12px;color:var(--text3);margin-top:4px;">üïê ${shop.hours||''}</div>
    </div>
    
    <!-- Action Buttons -->
    <div style="display:flex;gap:10px;">
      <a href="tel:${shop.phone||''}" style="flex:1;padding:14px;background:linear-gradient(135deg,var(--info),#1976D2);color:white;text-decoration:none;border-radius:12px;text-align:center;font-weight:700;font-size:14px;box-shadow:0 4px 15px rgba(33,150,243,0.3);">
        üìû Call Shop
      </a>
      <a href="https://maps.google.com/?q=${encodeURIComponent((shop.name||'TurboWash')+' '+(shop.address||'Pune'))}" target="_blank" style="flex:1;padding:14px;background:linear-gradient(135deg,var(--success),#00A846);color:white;text-decoration:none;border-radius:12px;text-align:center;font-weight:700;font-size:14px;box-shadow:0 4px 15px rgba(0,200,83,0.3);">
        üìç Get Directions
      </a>
    </div>
    
    <div style="text-align:center;margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
      <div style="font-size:11px;color:var(--text3);">Powered by TurboWash Laundry</div>
      <div style="font-size:10px;color:var(--text3);margin-top:4px;">Track your order anytime, anywhere</div>
    </div>
  `;
}

function applyRoleUI() {
  const isAdmin = currentUser.role === 'admin';
  const isOperatorPlus = currentUser.role === 'admin' || currentUser.role === 'operator';

  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = isAdmin ? '' : 'none';
  });
  document.querySelectorAll('.operator-plus').forEach(el => {
    el.style.display = isOperatorPlus ? '' : 'none';
  });

  // Hide FAB for viewers
  document.getElementById('fabBtn').style.display = isOperatorPlus ? '' : 'none';

  // Hide admin more section
  if (!isAdmin) {
    document.getElementById('adminMoreSection').style.display = 'none';
  }
}

function updateHeaderInfo() {
  const roleLabels = { admin: 'üëë Admin', operator: '‚öôÔ∏è Operator', viewer: 'üëÅÔ∏è Viewer' };
  document.getElementById('headerUserInfo').textContent = currentUser.name + ' ¬∑ ' + (roleLabels[currentUser.role] || '');
  document.getElementById('loggedInAs').textContent = 'Logged in as ' + currentUser.name;
}

function doLogout() {
  showConfirm('Logout', 'Are you sure you want to logout?', 'üö™', () => {
    DB.del('session');
    currentUser = null;
    if (dueDateRefreshInterval) clearInterval(dueDateRefreshInterval);
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    closeModal('userMenuModal');
  });
}

// ============================================================
// PAGE NAVIGATION
// ============================================================
function switchPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const navBtn = document.getElementById('nav-' + pageId);
  if (navBtn) navBtn.classList.add('active');

  if (pageId === 'pageDashboard') refreshDashboard();
  if (pageId === 'pageOrders') renderOrders();
  if (pageId === 'pageDueDate') renderDueDatePage();
  if (pageId === 'pageCustomers') renderCustomers();
}

// ============================================================
// DASHBOARD
// ============================================================
function refreshDashboard() {
  const orders = DB.get('orders') || [];
  const now = new Date(); now.setHours(0,0,0,0);
  const today = now.toISOString().split('T')[0];

  const todayOrders = orders.filter(o => o.createdAt && o.createdAt.startsWith(today));
  const pendingOrders = orders.filter(o => ['received','inprogress'].includes(o.status));
  const readyOrders = orders.filter(o => o.status === 'ready');
  const overdueOrders = orders.filter(o => isOverdue(o));

  document.getElementById('statToday').textContent = todayOrders.length;
  document.getElementById('statPending').textContent = pendingOrders.length;
  document.getElementById('statReady').textContent = readyOrders.length;
  document.getElementById('statOverdue').textContent = overdueOrders.length;

  if (currentUser.role === 'admin') {
    const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const recentOrders = orders.filter(o => new Date(o.createdAt) >= thirtyDaysAgo);
    const revenue = recentOrders.reduce((sum, o) => sum + (o.paidAmount || 0), 0);
    const unpaid = orders.filter(o => (o.totalAmount - (o.paidAmount||0)) > 0 && o.status !== 'cancelled');
    document.getElementById('statRevenue').textContent = '‚Çπ' + revenue.toFixed(0);
    document.getElementById('statUnpaid').textContent = unpaid.length;
    document.getElementById('statRevenueCard').style.display = '';
    document.getElementById('statUnpaidCard').style.display = '';
  }

  // Overdue banner
  const banner = document.getElementById('overdueBanner');
  if (overdueOrders.length > 0) {
    banner.classList.remove('hidden');
    document.getElementById('overdueText').textContent = overdueOrders.length + ' order' + (overdueOrders.length>1?'s are':' is') + ' overdue!';
    document.getElementById('notifBadge').textContent = overdueOrders.length;
    document.getElementById('notifBadge').classList.remove('hidden');
  } else {
    banner.classList.add('hidden');
    document.getElementById('notifBadge').classList.add('hidden');
  }

  // Greeting
  const h = new Date().getHours();
  const greet = h < 12 ? 'Good Morning! ‚òÄÔ∏è' : h < 17 ? 'Good Afternoon! üå§Ô∏è' : 'Good Evening! üåô';
  document.getElementById('dashGreeting').textContent = greet;
  document.getElementById('dashDate').textContent = formatDate(new Date()) + ' | ' + (DB.get('shopSettings')||{}).name;

  // Recent orders
  const recent = [...orders].sort((a,b) => new Date(b.createdAt)-new Date(a.createdAt)).slice(0,10);
  const container = document.getElementById('recentOrdersList');
  if (recent.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><h3>No orders yet</h3><p>Create your first order!</p></div>';
  } else {
    container.innerHTML = recent.map(o => renderOrderCard(o)).join('');
  }
}

// ============================================================
// ORDER HELPERS
// ============================================================
function checkIfNeedsNotification(order) {
  // Only for ready and delivered status
  if (order.status !== 'ready' && order.status !== 'delivered') return false;
  
  // Check if notification was sent for current status
  if (!order.notificationsSent || order.notificationsSent.length === 0) {
    // Check if status changed recently (within last 24 hours)
    const statusHistory = order.statusHistory || [];
    const currentStatusEntry = statusHistory.find(h => h.status === order.status);
    if (currentStatusEntry) {
      const changedAt = new Date(currentStatusEntry.changedAt);
      const now = new Date();
      const hoursSince = (now - changedAt) / (1000 * 60 * 60);
      return hoursSince < 24; // Show notification for 24 hours
    }
    return true;
  }
  
  // Check if notification sent for THIS status
  const sentForThisStatus = order.notificationsSent.some(n => n.status === order.status);
  if (sentForThisStatus) return false;
  
  // Status changed but not notified
  return true;
}

function isOverdue(order) {
  if (!order.dueDate || order.status === 'delivered' || order.status === 'cancelled') return false;
  const due = new Date(order.dueDate); due.setHours(23,59,59,0);
  return new Date() > due;
}

function isDueToday(order) {
  if (!order.dueDate || order.status === 'delivered' || order.status === 'cancelled') return false;
  const today = new Date().toISOString().split('T')[0];
  return order.dueDate === today && !isOverdue(order);
}

function formatDate(d) {
  if (!d) return '-';
  const date = typeof d === 'string' ? new Date(d) : d;
  return date.toLocaleDateString('en-IN', {day:'2-digit', month:'short', year:'numeric'});
}

function formatDateTime(d) {
  if (!d) return '-';
  const date = typeof d === 'string' ? new Date(d) : d;
  return date.toLocaleDateString('en-IN', {day:'2-digit', month:'short'}) + ' ' + date.toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit'});
}

function getStatusLabel(status) {
  const labels = { received:'Received', inprogress:'In Progress', ready:'Ready', delivered:'Delivered', cancelled:'Cancelled' };
  return labels[status] || status;
}

function getStatusClass(status) {
  const cls = { received:'status-received', inprogress:'status-inprogress', ready:'status-ready', delivered:'status-delivered', cancelled:'status-cancelled' };
  return cls[status] || '';
}

function renderOrderCard(order) {
  const overdue = isOverdue(order);
  
  // Check if status changed but WhatsApp not sent
  const needsNotification = checkIfNeedsNotification(order);
  const dueToday = isDueToday(order);
  const balance = (order.totalAmount||0) - (order.paidAmount||0);
  const counts = DB.get('shareCounts') || {};
  const waCount = counts['wa_'+order.id] || 0;
  const invCount = counts['inv_'+order.id] || 0;
  return `<div class="order-card">
    <div onclick="showOrderDetail('${order.id}')">
      <div class="order-card-top">
        <div>
          <div class="order-num">${order.orderNo}</div>
          <div class="order-date">${formatDateTime(order.createdAt)}</div>
        </div>
        <span class="status-badge ${getStatusClass(order.status)}">${getStatusLabel(order.status)}</span>
      </div>
      <div class="order-customer">${order.customerName}</div>
      <div class="order-phone">üìû ${order.customerPhone}</div>
      <div class="order-services">${(order.services||[]).map(s=>`<span class="service-tag">${s.serviceName}</span>`).join('')}</div>
      <div class="order-card-bottom">
        <div>
          <div class="order-amount">‚Çπ${(order.totalAmount||0).toFixed(0)}</div>
          ${balance > 0 ? `<div class="order-balance">Balance: ‚Çπ${balance.toFixed(0)}</div>` : '<div style="font-size:11px;color:var(--success);font-weight:600;">‚úÖ Paid</div>'}
        </div>
        <div class="order-due ${overdue?'overdue':dueToday?'due-today':''}">
          üìÖ ${overdue?'üö® OVERDUE':dueToday?'‚ö†Ô∏è Due Today':'Due: '+formatDate(order.dueDate)}
        </div>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">
      <button onclick="event.stopPropagation();quickShareWhatsAppText('${order.id}')"
        style="flex:1;padding:8px 6px;border-radius:8px;border:1.5px solid #25D366;background:rgba(37,211,102,0.1);color:#128C7E;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:3px;">
        üí¨ Share on WhatsApp
      </button>
      <button onclick="event.stopPropagation();quickShareInvoiceImage('${order.id}')"
        style="flex:1;padding:8px 6px;border-radius:8px;border:1.5px solid var(--orange);background:rgba(255,107,0,0.1);color:var(--orange);font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:3px;">
        üìÑ Share Invoice
      </button>
    </div>
    ${needsNotification ? `<div style="margin-top:8px;padding:8px 10px;background:linear-gradient(135deg,#FFB300,#F57F17);border-radius:8px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:16px;">üì¢</span>
      <div style="flex:1;color:white;">
        <div style="font-size:11px;font-weight:700;">Status Updated!</div>
        <div style="font-size:10px;opacity:0.9;">Send notification to customer</div>
      </div>
    </div>` : ''}
  </div>`;
}

// ============================================================
// ORDERS PAGE
// ============================================================
function renderOrders() {
  const orders = DB.get('orders') || [];
  const search = (document.getElementById('orderSearch')||{}).value || '';
  let filtered = orders;

  if (currentOrderFilter !== 'all') {
    filtered = filtered.filter(o => o.status === currentOrderFilter);
  }
  if (search.trim()) {
    const q = search.toLowerCase();
    filtered = filtered.filter(o =>
      o.customerName.toLowerCase().includes(q) ||
      o.customerPhone.includes(q) ||
      o.orderNo.toLowerCase().includes(q)
    );
  }
  filtered.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

  const container = document.getElementById('ordersList');
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><h3>No orders found</h3><p>Try different filters or create a new order</p></div>';
  } else {
    container.innerHTML = filtered.map(o => renderOrderCard(o)).join('');
  }
}

function setOrderFilter(filter, el) {
  currentOrderFilter = filter;
  document.querySelectorAll('#orderFilterTabs .filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderOrders();
}

function filterOrders() { renderOrders(); }

// ============================================================
// DUE DATE PAGE
// ============================================================
function renderDueDatePage() {
  const orders = DB.get('orders') || [];
  const active = orders.filter(o => o.status !== 'delivered' && o.status !== 'cancelled');

  const overdue = active.filter(o => isOverdue(o)).sort((a,b) => new Date(a.dueDate)-new Date(b.dueDate));
  const dueToday = active.filter(o => isDueToday(o)).sort((a,b) => new Date(a.dueDate)-new Date(b.dueDate));
  const upcoming = active.filter(o => !isOverdue(o) && !isDueToday(o) && o.dueDate).sort((a,b) => new Date(a.dueDate)-new Date(b.dueDate));

  let html = '';

  if (overdue.length > 0) {
    html += `<div class="due-section">
      <div class="due-section-title overdue">üö® Overdue <span style="background:#F44336;color:white;border-radius:10px;padding:1px 8px;font-size:11px;margin-left:4px;">${overdue.length}</span></div>
      <div style="padding:0 16px;display:flex;flex-direction:column;gap:8px;">${overdue.map(o=>renderOrderCard(o)).join('')}</div>
    </div>`;
  }

  if (dueToday.length > 0) {
    html += `<div class="due-section">
      <div class="due-section-title today">‚ö†Ô∏è Due Today <span style="background:#FFB300;color:white;border-radius:10px;padding:1px 8px;font-size:11px;margin-left:4px;">${dueToday.length}</span></div>
      <div style="padding:0 16px;display:flex;flex-direction:column;gap:8px;">${dueToday.map(o=>renderOrderCard(o)).join('')}</div>
    </div>`;
  }

  if (upcoming.length > 0) {
    html += `<div class="due-section">
      <div class="due-section-title upcoming">üìÖ Upcoming <span style="background:#00C853;color:white;border-radius:10px;padding:1px 8px;font-size:11px;margin-left:4px;">${upcoming.length}</span></div>
      <div style="padding:0 16px;display:flex;flex-direction:column;gap:8px;">${upcoming.map(o=>renderOrderCard(o)).join('')}</div>
    </div>`;
  }

  if (html === '') {
    html = '<div class="empty-state"><div class="empty-icon">üìÖ</div><h3>All clear!</h3><p>No pending due dates</p></div>';
  }

  const lastUpdated = `<div style="text-align:center;padding:8px;font-size:11px;color:var(--text3);">Last updated: ${formatDateTime(new Date())}</div>`;
  document.getElementById('dueDateContent').innerHTML = html + lastUpdated;
}

function checkOverduePopup() {
  const orders = DB.get('orders') || [];
  const overdue = orders.filter(o => isOverdue(o));
  if (overdue.length === 0) return;

  const lastPopup = DB.get('lastOverduePopup');
  const today = new Date().toISOString().split('T')[0];
  if (lastPopup === today) return;

  DB.set('lastOverduePopup', today);

  let bodyHtml = overdue.map(o => `
    <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-weight:700;font-size:13px;">${o.orderNo} - ${o.customerName}</div>
        <div style="font-size:11px;color:var(--text2);">Due: ${formatDate(o.dueDate)}</div>
      </div>
      <span class="status-badge ${getStatusClass(o.status)}">${getStatusLabel(o.status)}</span>
    </div>`).join('');

  showPopup('üö®', 'Orders Overdue!', overdue.length + ' order(s) have passed their due date', bodyHtml, [
    { label:'View Due Dates', cls:'btn-danger', action:'switchPage("pageDueDate");closePopup();' },
    { label:'Dismiss', cls:'btn-secondary', action:'closePopup()' }
  ]);
}

// ============================================================
// NEW/EDIT ORDER MODAL
// ============================================================
function showNewOrderModal(prefillCustomer) {
  if (currentUser.role === 'viewer') { showToast('Viewers cannot create orders', 'error'); return; }
  editingOrderId = null;
  document.getElementById('orderModalTitle').textContent = 'New Order';
  renderOrderForm(null, prefillCustomer);
  openModal('orderModal');
}

function showEditOrder(orderId) {
  if (currentUser.role === 'viewer') { showToast('Viewers cannot edit orders', 'error'); return; }
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  editingOrderId = orderId;
  document.getElementById('orderModalTitle').textContent = 'Edit Order - ' + order.orderNo;
  renderOrderForm(order);
  closeModal('orderDetailModal');
  openModal('orderModal');
}

function renderOrderForm(order, prefillCustomer) {
  const services = (DB.get('services') || []).filter(s => s.active);
  const today = new Date().toISOString().split('T')[0];

  const selectedServices = order ? order.services : [];

  const html = `
    <div class="form-section">
      <div class="form-section-title">üë§ Customer Details</div>
      <div class="field">
        <label>Customer Name *</label>
        <input type="text" id="f_customerName" value="${order?order.customerName:prefillCustomer?prefillCustomer.name:''}" placeholder="Enter customer name" oninput="searchCustomerSuggest(this.value)">
        <div id="customerSuggestions" style="background:white;border:1px solid var(--border);border-radius:8px;margin-top:4px;overflow:hidden;display:none;"></div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Phone *</label>
          <input type="tel" id="f_customerPhone" value="${order?order.customerPhone:prefillCustomer?prefillCustomer.phone:''}" placeholder="10 digit phone">
        </div>
        <div class="field">
          <label>Alt. Phone</label>
          <input type="tel" id="f_customerPhone2" value="${order?order.customerPhone2||'':''}" placeholder="Optional">
        </div>
      </div>
      <div style="margin-bottom:14px;">
        <button type="button" onclick="toggleAddressField()"
          style="background:rgba(255,107,0,0.08);border:1.5px dashed var(--orange);color:var(--orange);font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;width:100%;justify-content:center;">
          <span id="addressToggleIcon">‚ûï</span> <span id="addressToggleText">Add Address (Optional)</span>
        </button>
        <div id="addressFieldWrap" style="display:none;margin-top:8px;">
          <input type="text" id="f_customerAddress" value="${order?order.customerAddress||'':''}"
            placeholder="Customer address"
            style="width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;font-family:'Poppins',sans-serif;outline:none;transition:border-color 0.2s;">
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">üìÖ Order Details</div>
      <div class="field-row">
        <div class="field">
          <label>Order Date</label>
          <input type="date" id="f_orderDate" value="${order?order.orderDate:today}" max="${today}">
        </div>
        <div class="field">
          <label>Due Date *</label>
          <div class="due-options">
            <div class="due-opt" onclick="setDueDate('same',this)">Same Day</div>
            <div class="due-opt" onclick="setDueDate('2',this)">+2 Days</div>
            <div class="due-opt" onclick="setDueDate('4',this)">+4 Days</div>
            <div class="due-opt" onclick="setDueDate('5',this)">+5 Days</div>
            <div class="due-opt" onclick="setDueDate('custom',this)">Custom</div>
          </div>
          <input type="date" id="f_dueDate" value="${order?order.dueDate:today}" min="${today}" style="margin-top:6px;">
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">üß∫ Services</div>
      <div class="service-chips" id="serviceChips">
        ${services.map(s => `
          <div class="service-chip ${selectedServices.find(ss=>ss.serviceId===s.id)?'active':''}"
            onclick="toggleService('${s.id}','${s.name}','${s.pricingType}',this)"
            data-id="${s.id}" data-name="${s.name}" data-pricing="${s.pricingType}">
            ${s.icon} ${s.name}
          </div>`).join('')}
      </div>
      <div id="serviceItemsContainer" style="margin-top:14px;"></div>
    </div>

    <div class="form-section">
      <div class="form-section-title">üí∞ Payment</div>
      <div class="payment-summary" id="paymentSummary">
        <div class="pay-row"><span>Total Amount</span><strong id="ps_total">‚Çπ0.00</strong></div>
        <hr class="pay-divider">
        <div class="pay-row" style="flex-direction:column;align-items:flex-start;gap:8px;">
          <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
            <span>Advance Paid</span>
            <div style="display:flex;gap:6px;">
              <button id="btn_unpaid" onclick="setPaymentStatus('unpaid')"
                style="padding:4px 12px;border-radius:20px;border:1.5px solid rgba(255,255,255,0.4);background:rgba(244,67,54,0.7);color:white;font-size:11px;font-weight:700;cursor:pointer;">
                Unpaid
              </button>
              <button id="btn_paid" onclick="setPaymentStatus('paid')"
                style="padding:4px 12px;border-radius:20px;border:1.5px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);font-size:11px;font-weight:700;cursor:pointer;">
                Paid
              </button>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;width:100%;">
            <span style="font-size:12px;opacity:0.7;">Amount:</span>
            <input type="number" id="f_advancePaid" value="${order?order.paidAmount||0:0}" min="0" step="0.01"
              style="flex:1;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:6px;padding:6px 10px;color:white;text-align:right;font-size:15px;font-family:'Nunito',sans-serif;font-weight:800;"
              oninput="updatePaymentSummary()">
          </div>
        </div>
        <div class="pay-row pay-balance"><span>Balance Due</span><strong id="ps_balance">‚Çπ0.00</strong></div>
        <hr class="pay-divider">
        <div class="pay-row">
          <span>Payment Mode</span>
          <select id="f_paymentMode" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:6px;padding:4px 8px;color:white;font-size:13px;">
            <option value="cash" ${order&&order.paymentMode==='cash'?'selected':''} style="color:black;">Cash</option>
            <option value="upi" ${order&&order.paymentMode==='upi'?'selected':''} style="color:black;">UPI (GPay/PhonePe)</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-section-title">üìù Notes</div>
      <div class="field">
        <label>Special Instructions</label>
        <textarea id="f_notes" placeholder="Any special instructions or notes...">${order?order.notes||'':''}</textarea>
      </div>
    </div>`;

  document.getElementById('orderModalBody').innerHTML = html;

  // Auto show address if order has one
  if (order && order.customerAddress) {
    setTimeout(() => autoShowAddress(order.customerAddress), 100);
  }
  // Pre-fill services if editing - CRITICAL: populate serviceItemsData first
  serviceItemsData = {}; // Reset always
  if (order && order.services) {
    order.services.forEach(sv => {
      // Mark chip as active
      const chip = document.querySelector(`.service-chip[data-id="${sv.serviceId}"]`);
      if (chip) chip.classList.add('active');
      // Load items into serviceItemsData
      serviceItemsData[sv.serviceId] = sv.items && sv.items.length > 0 
        ? sv.items.map(i => ({...i})) 
        : [{ name:'', qty:1, price:'', subtotal:0 }];
      renderServiceItems(sv.serviceId, sv.serviceName, sv.pricingType, serviceItemsData[sv.serviceId]);
    });
  }

  // Set due date selection
  if (order) {
    // Don't auto-set, just show current value
  }

  updatePaymentSummary();
}

function setDueDate(type, el) {
  document.querySelectorAll('.due-opt').forEach(o => o.classList.remove('active'));
  el.classList.add('active');
  const today = new Date();
  let date = new Date(today);
  if (type === 'same') { /* today */ }
  else if (type === 'custom') { document.getElementById('f_dueDate').focus(); return; }
  else { date.setDate(date.getDate() + parseInt(type)); }
  document.getElementById('f_dueDate').value = date.toISOString().split('T')[0];
}

let serviceItemsData = {};

function toggleService(id, name, pricingType, el) {
  el.classList.toggle('active');
  if (el.classList.contains('active')) {
    if (!serviceItemsData[id]) {
      const autoName = getAutoName(id, pricingType);
      const autoPrice = getDefaultPrice(id);
      serviceItemsData[id] = [{ name:autoName, qty:1, price:autoPrice, subtotal:0, discount:0 }];
    }
    renderServiceItems(id, name, pricingType, serviceItemsData[id]);
  } else {
    const container = document.getElementById('svc_'+id);
    if (container) container.remove();
    delete serviceItemsData[id];
    updatePaymentSummary();
  }
}

function renderServiceItems(serviceId, serviceName, pricingType, existingItems) {
  const container = document.getElementById('serviceItemsContainer');
  let existing = document.getElementById('svc_'+serviceId);
  if (existing && existing.parentNode) {
    // Blur active element first to avoid NotFoundError on remove
    if (document.activeElement && existing.contains(document.activeElement)) {
      document.activeElement.blur();
    }
    try { existing.parentNode.removeChild(existing); } catch(e) { /* already removed */ }
  }

  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  const savedItems = svc ? (svc.items || []) : [];

  serviceItemsData[serviceId] = existingItems && existingItems.length > 0 ? existingItems : [{ name:'', qty:1, price:'', subtotal:0 }];

  const calcSub = (item) => Math.max(0, ((parseFloat(item.qty)||1)*(parseFloat(item.price)||0)) - (parseFloat(item.discount)||0));

  const renderTable = () => {
    const items = serviceItemsData[serviceId];
    return `<div id="svc_${serviceId}" style="margin-bottom:16px;background:var(--card2);border-radius:12px;padding:10px;border:1px solid var(--border);">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <span style="font-weight:700;font-size:13px;color:var(--orange);">${serviceName}</span>
        <span style="font-size:11px;color:var(--text2);">${pricingType==='per_kg'?'Per KG':'Per Item'}</span>
      </div>
      <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:340px;">
        <thead>
          <tr style="background:rgba(255,107,0,0.08);">
            <th style="padding:6px 4px;text-align:left;font-size:10px;color:var(--text2);font-weight:700;min-width:90px;">ITEM</th>
            <th style="padding:6px 4px;text-align:center;font-size:10px;color:var(--text2);font-weight:700;width:80px;">${pricingType==='per_kg'?'KG':'QTY'}</th>
            <th style="padding:6px 4px;text-align:center;font-size:10px;color:var(--text2);font-weight:700;width:65px;">PRICE</th>
            <th style="padding:6px 4px;text-align:center;font-size:10px;color:var(--text2);font-weight:700;width:55px;">DISC(‚Çπ)</th>
            <th style="padding:6px 4px;text-align:right;font-size:10px;color:var(--orange);font-weight:700;width:50px;">SUB</th>
            <th style="width:24px;"></th>
          </tr>
        </thead>
        <tbody>
          ${items.map((item,i) => `<tr style="border-bottom:1px solid var(--border);">
            <td style="padding:5px 4px;">
              <input list="items_${serviceId}_${i}" type="text" value="${item.name||''}"
                onchange="updateItemField('${serviceId}',${i},'name',this.value);autoFillPriceOnChange('${serviceId}',${i},'${serviceName}')"
                oninput="updateItemField('${serviceId}',${i},'name',this.value)"
                placeholder="${getServicePlaceholder(serviceId)}"
                style="width:100%;min-width:85px;border:1px solid var(--border);border-radius:5px;padding:5px 6px;font-size:12px;font-family:'Poppins',sans-serif;outline:none;box-sizing:border-box;">
              <datalist id="items_${serviceId}_${i}">
                ${savedItems.map(si=>`<option value="${si.name}">`).join('')}
              </datalist>
            </td>
            <td style="padding:5px 4px;">
              ${pricingType==='per_kg' ? `
                <input type="number" min="0.1" step="0.1" value="${item.qty||1}"
                  onchange="updateItemField('${serviceId}',${i},'qty',parseFloat(this.value)||0.1);updateSubDisplay('${serviceId}',${i});updatePaymentSummary()"
                  oninput="updateItemField('${serviceId}',${i},'qty',parseFloat(this.value)||0.1);updateSubDisplay('${serviceId}',${i});updatePaymentSummary()"
                  placeholder="KG"
                  style="width:52px;text-align:center;border:1.5px solid var(--orange);border-radius:6px;padding:5px 4px;font-size:13px;font-weight:700;color:var(--orange);">
              ` : `
                <div style="display:flex;align-items:center;gap:1px;justify-content:center;">
                  <button onclick="changeQty('${serviceId}',${i},-1)" style="width:20px;height:20px;border-radius:4px;border:1px solid var(--border);background:white;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;padding:0;">‚àí</button>
                  <input type="number" min="1" step="1" value="${item.qty||1}"
                    onchange="updateItemField('${serviceId}',${i},'qty',parseFloat(this.value)||1);updateSubDisplay('${serviceId}',${i});updatePaymentSummary()"
                    oninput="updateItemField('${serviceId}',${i},'qty',parseFloat(this.value)||1);updateSubDisplay('${serviceId}',${i});updatePaymentSummary()"
                    style="width:32px;text-align:center;border:1px solid var(--border);border-radius:4px;padding:3px 1px;font-size:12px;">
                  <button onclick="changeQty('${serviceId}',${i},1)" style="width:20px;height:20px;border-radius:4px;border:none;background:var(--orange);color:white;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;padding:0;">+</button>
                </div>
              `}
            </td>
            <td style="padding:5px 4px;">
              <input type="number" min="0" step="0.5" value="${item.price||''}"
                onchange="updateItemField('${serviceId}',${i},'price',parseFloat(this.value)||0);updateSubDisplay('${serviceId}',${i});updatePaymentSummary()"
                oninput="updateItemField('${serviceId}',${i},'price',parseFloat(this.value)||0);updateSubDisplay('${serviceId}',${i});updatePaymentSummary()"
                placeholder="0"
                style="width:100%;border:1px solid var(--border);border-radius:5px;padding:5px 4px;font-size:12px;text-align:center;">
            </td>
            <td style="padding:5px 4px;">
              <input type="number" min="0" step="1" value="${item.discount||0}"
                onchange="updateItemField('${serviceId}',${i},'discount',parseFloat(this.value)||0);updateSubDisplay('${serviceId}',${i});updatePaymentSummary()"
                oninput="updateItemField('${serviceId}',${i},'discount',parseFloat(this.value)||0);updateSubDisplay('${serviceId}',${i});updatePaymentSummary()"
                placeholder="0"
                style="width:100%;border:1px solid #29B6F6;border-radius:5px;padding:5px 4px;font-size:12px;text-align:center;color:#0277BD;">
            </td>
            <td style="padding:5px 4px;text-align:right;font-weight:800;font-size:13px;color:var(--orange);white-space:nowrap;">‚Çπ${calcSub(item).toFixed(0)}</td>
            <td style="padding:5px 2px;"><button onclick="removeItemRow('${serviceId}',${i})" style="background:none;border:none;cursor:pointer;color:var(--danger);font-size:14px;padding:2px;">üóë</button></td>
          </tr>`).join('')}
        </tbody>
      </table>
      </div>
      <button class="add-item-btn" onclick="addItemRow('${serviceId}','${serviceName}','${pricingType}')">+ Add Item</button>
    </div>`;
  };

  const div = document.createElement('div');
  div.innerHTML = renderTable();
  container.appendChild(div.firstElementChild);
}

function autoFillPrice(serviceId, rowIndex, serviceName) {
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc || !svc.items) return;
  const itemName = serviceItemsData[serviceId][rowIndex].name;
  const match = svc.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
  if (match && !serviceItemsData[serviceId][rowIndex].price) {
    serviceItemsData[serviceId][rowIndex].price = match.price;
    renderServiceItems(serviceId, serviceName, svc.pricingType, serviceItemsData[serviceId]);
    updatePaymentSummary();
  }
}

function getServicePlaceholder(serviceId) {
  // First try by ID
  const byId = {
    's2': 'Wash and Fold',
    's3': 'Wash and Iron',
    's4': 'Steam Iron',
    's5': 'Shoe Cleaning',
    's6': 'Saree Roll Press',
    's7': 'Dying',
    's8': 'Normal Iron'
  };
  if (byId[serviceId]) return byId[serviceId];
  // Fallback: look up service name from DB
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc) return 'Item name...';
  const byName = {
    'wash & fold': 'Wash and Fold',
    'wash & iron': 'Wash and Iron',
    'steam ironing': 'Steam Iron',
    'shoe cleaning': 'Shoe Cleaning',
    'saree roll press': 'Saree Roll Press',
    'dying': 'Dying',
    'normal iron': 'Normal Iron'
  };
  return byName[svc.name.toLowerCase()] || svc.name;
}

const _reRenderTimers = {};
function reRenderService(serviceId, serviceName, pricingType) {
  // Debounce: wait 150ms after last keystroke before re-rendering
  clearTimeout(_reRenderTimers[serviceId]);
  _reRenderTimers[serviceId] = setTimeout(() => {
    // Save active element info before re-render
    const active = document.activeElement;
    const activeId = active ? active.id : null;
    const activeName = active ? active.name : null;
    const activeVal = active ? active.value : null;

    renderServiceItems(serviceId, serviceName, pricingType, serviceItemsData[serviceId]);
    updatePaymentSummary();

    // Restore focus to same input after re-render if possible
    if (activeId) {
      const el = document.getElementById(activeId);
      if (el) { el.focus(); el.value = activeVal || el.value; }
    }
  }, 150);
}

function autoFillPriceOnChange(serviceId, rowIndex, serviceName) {
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc || !svc.items) return;
  const itemName = (serviceItemsData[serviceId][rowIndex]||{}).name || '';
  const match = svc.items.find(i => i.name.toLowerCase() === itemName.toLowerCase());
  if (match) {
    serviceItemsData[serviceId][rowIndex].price = match.price;
    reRenderService(serviceId, serviceName, svc.pricingType);
  }
}

function changeQty(serviceId, rowIndex, delta) {
  if (!serviceItemsData[serviceId]) return;
  const current = parseFloat(serviceItemsData[serviceId][rowIndex].qty) || 1;
  const newQty = Math.max(1, Math.round(current + delta));
  serviceItemsData[serviceId][rowIndex].qty = newQty;
  // Update qty input value directly without re-rendering
  const svcEl = document.getElementById('svc_' + serviceId);
  if (svcEl) {
    const rows = svcEl.querySelectorAll('tbody tr');
    if (rows[rowIndex]) {
      const qtyInput = rows[rowIndex].querySelector('input[type="number"]');
      if (qtyInput) qtyInput.value = newQty;
    }
  }
  updateSubDisplay(serviceId, rowIndex);
  updatePaymentSummary();
}

function updateItemField(serviceId, rowIndex, field, value) {
  if (!serviceItemsData[serviceId]) return;
  serviceItemsData[serviceId][rowIndex][field] = field==='qty'||field==='price' ? parseFloat(value)||0 : value;
}

function getDefaultPrice(serviceId) {
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc || !svc.items || svc.items.length === 0) return '';
  return svc.items[0].price || '';
}

function getDefaultItemName(serviceId) {
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc || !svc.items || svc.items.length === 0) return '';
  return svc.items[0].name || '';
}

function getAutoName(serviceId, pricingType) {
  // For per_kg services, use service name
  const autoNames = {'s2':'Wash and Fold','s3':'Wash and Iron','s4':'Steam Iron','s5':'Shoe Cleaning','s6':'Saree Roll Press','s7':'Dying','s8':'Normal Iron'};
  if (pricingType === 'per_kg') return autoNames[serviceId] || '';
  
  // For per_item services, use first item name from service items
  const defaultName = getDefaultItemName(serviceId);
  return defaultName || autoNames[serviceId] || '';
}

function addItemRow(serviceId, serviceName, pricingType) {
  const autoName = getAutoName(serviceId, pricingType);
  const autoPrice = getDefaultPrice(serviceId);
  serviceItemsData[serviceId].push({ name:autoName, qty:1, price:autoPrice, subtotal:0, discount:0 });
  renderServiceItems(serviceId, serviceName, pricingType, serviceItemsData[serviceId]);
  updatePaymentSummary();
}

function removeItemRow(serviceId, rowIndex) {
  serviceItemsData[serviceId].splice(rowIndex, 1);
  if (serviceItemsData[serviceId].length === 0) serviceItemsData[serviceId].push({ name:'', qty:1, price:'', subtotal:0 });
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  renderServiceItems(serviceId, svc?svc.name:'', svc?svc.pricingType:'per_item', serviceItemsData[serviceId]);
  updatePaymentSummary();
}

function setPaymentStatus(status) {
  const total = calcOrderTotal();
  const paidBtn = document.getElementById('btn_paid');
  const unpaidBtn = document.getElementById('btn_unpaid');
  if (status === 'paid') {
    document.getElementById('f_advancePaid').value = total.toFixed(2);
    if (paidBtn) { paidBtn.style.background='rgba(0,200,83,0.8)'; paidBtn.style.border='1.5px solid rgba(255,255,255,0.6)'; paidBtn.style.color='white'; }
    if (unpaidBtn) { unpaidBtn.style.background='rgba(255,255,255,0.1)'; unpaidBtn.style.border='1.5px solid rgba(255,255,255,0.2)'; unpaidBtn.style.color='rgba(255,255,255,0.6)'; }
  } else {
    document.getElementById('f_advancePaid').value = '0';
    if (unpaidBtn) { unpaidBtn.style.background='rgba(244,67,54,0.7)'; unpaidBtn.style.border='1.5px solid rgba(255,255,255,0.4)'; unpaidBtn.style.color='white'; }
    if (paidBtn) { paidBtn.style.background='rgba(255,255,255,0.1)'; paidBtn.style.border='1.5px solid rgba(255,255,255,0.2)'; paidBtn.style.color='rgba(255,255,255,0.6)'; }
  }
  updatePaymentSummary();
}

function calcItemSub(item) {
  return Math.max(0, ((parseFloat(item.qty)||1)*(parseFloat(item.price)||0)) - (parseFloat(item.discount)||0));
}

// Update only the SUB display cell without re-rendering entire table (avoids blur error)
function updateSubDisplay(serviceId, rowIndex) {
  const item = (serviceItemsData[serviceId]||[])[rowIndex];
  if (!item) return;
  const sub = calcItemSub(item);
  // Find sub cell: each row has 6 cells, sub is 5th (index 4)
  const tableId = 'svc_' + serviceId;
  const svcEl = document.getElementById(tableId);
  if (!svcEl) return;
  const rows = svcEl.querySelectorAll('tbody tr');
  if (rows[rowIndex]) {
    const cells = rows[rowIndex].querySelectorAll('td');
    if (cells[4]) cells[4].textContent = '‚Çπ' + sub.toFixed(0);
  }
}

function calcOrderTotal() {
  let total = 0;
  Object.values(serviceItemsData).forEach(items => {
    items.forEach(item => { total += calcItemSub(item); });
  });
  return total;
}

function updatePaymentSummary() {
  let total = 0;
  Object.values(serviceItemsData).forEach(items => {
    items.forEach(item => { total += calcItemSub(item); });
  });
  const advance = parseFloat(document.getElementById('f_advancePaid')?.value) || 0;
  const balance = Math.max(0, total - advance);
  if(document.getElementById('ps_total')) document.getElementById('ps_total').textContent = '‚Çπ' + total.toFixed(2);
  if(document.getElementById('ps_balance')) document.getElementById('ps_balance').textContent = '‚Çπ' + balance.toFixed(2);
}

function toggleAddressField() {
  const wrap = document.getElementById('addressFieldWrap');
  const icon = document.getElementById('addressToggleIcon');
  const txt = document.getElementById('addressToggleText');
  if (wrap.style.display === 'none') {
    wrap.style.display = 'block';
    icon.textContent = '‚ûñ';
    txt.textContent = 'Hide Address';
    wrap.querySelector('input').focus();
  } else {
    wrap.style.display = 'none';
    icon.textContent = '‚ûï';
    txt.textContent = 'Add Address (Optional)';
  }
}

function autoShowAddress(val) {
  if (val) {
    const wrap = document.getElementById('addressFieldWrap');
    const icon = document.getElementById('addressToggleIcon');
    const txt = document.getElementById('addressToggleText');
    if (wrap) { wrap.style.display='block'; icon.textContent='‚ûñ'; txt.textContent='Hide Address'; }
  }
}

function searchCustomerSuggest(query) {
  const box = document.getElementById('customerSuggestions');
  if (!query || query.length < 2) { box.style.display='none'; return; }
  const customers = DB.get('customers') || [];
  const matches = customers.filter(c => c.name.toLowerCase().includes(query.toLowerCase()) || c.phone.includes(query)).slice(0,5);
  if (matches.length === 0) { box.style.display='none'; return; }
  box.innerHTML = matches.map(c => `<div onclick="fillCustomer('${c.id}')" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border);font-size:13px;" onmouseover="this.style.background='#f8f9ff'" onmouseout="this.style.background=''">
    <strong>${c.name}</strong> <span style="color:var(--text3)">${c.phone}</span>
  </div>`).join('');
  box.style.display = 'block';
}

function fillCustomer(customerId) {
  const customers = DB.get('customers') || [];
  const c = customers.find(c => c.id === customerId);
  if (!c) return;
  document.getElementById('f_customerName').value = c.name;
  document.getElementById('f_customerPhone').value = c.phone;
  document.getElementById('f_customerPhone2').value = c.phone2 || '';
  if (c.address) {
    autoShowAddress(c.address);
    const addrEl = document.getElementById('f_customerAddress');
    if (addrEl) addrEl.value = c.address;
  }
  document.getElementById('customerSuggestions').style.display = 'none';
}

function saveOrder() {
  const name = document.getElementById('f_customerName').value.trim();
  const phone = document.getElementById('f_customerPhone').value.trim();
  const dueDate = document.getElementById('f_dueDate').value;
  const orderDate = document.getElementById('f_orderDate').value;

  if (!name) { showToast('Please enter customer name', 'error'); return; }
  if (!phone || phone.length < 10) { showToast('Please enter valid phone number', 'error'); return; }
  if (!dueDate) { showToast('Please select due date', 'error'); return; }
  if (Object.keys(serviceItemsData).length === 0) { showToast('Please select at least one service', 'error'); return; }

  // Build services array
  const services = DB.get('services') || [];
  const orderServices = Object.entries(serviceItemsData).map(([serviceId, items]) => {
    const svc = services.find(s => s.id === serviceId);
    const serviceTotal = items.reduce((sum, i) => sum + calcItemSub(i), 0);
    return {
      serviceId, serviceName: svc?svc.name:'', pricingType: svc?svc.pricingType:'per_item',
      items: items.filter(i => i.name||i.price),
      serviceTotal
    };
  });

  const totalAmount = orderServices.reduce((sum, s) => sum + s.serviceTotal, 0);
  const paidAmount = parseFloat(document.getElementById('f_advancePaid').value) || 0;
  const paymentMode = document.getElementById('f_paymentMode').value;
  const notes = document.getElementById('f_notes').value.trim();
  const phone2 = document.getElementById('f_customerPhone2').value.trim();
  const address = document.getElementById('f_customerAddress').value.trim();

  const orders = DB.get('orders') || [];

  // Save/update customer
  saveOrUpdateCustomer({ name, phone, phone2, address });

  // Save item names to service for future suggestions
  saveItemsToServices(serviceItemsData);

  if (editingOrderId) {
    const idx = orders.findIndex(o => o.id === editingOrderId);
    if (idx > -1) {
      orders[idx] = {
        ...orders[idx],
        customerName: name, customerPhone: phone, customerPhone2: phone2, customerAddress: address,
        orderDate, dueDate, services: orderServices, totalAmount, paidAmount, paymentMode, notes,
        updatedAt: new Date().toISOString(), updatedBy: currentUser.name
      };
    }
    DB.set('orders', orders);
    showToast('Order updated successfully! ‚úÖ', 'success');
  } else {
    const counter = (DB.get('orderCounter') || 0) + 1;
    DB.set('orderCounter', counter);
    const shop = DB.get('shopSettings') || {};
    const prefix = shop.orderPrefix || 'TWL';
    const orderNo = prefix + '-' + String(counter).padStart(3, '0');

    const newOrder = {
      id: 'ord_' + Date.now(), orderNo, orderDate, dueDate,
      customerName: name, customerPhone: phone, customerPhone2: phone2, customerAddress: address,
      services: orderServices, totalAmount, paidAmount, paymentMode, notes,
      status: 'received',
      statusHistory: [{ status:'received', changedAt: new Date().toISOString(), changedBy: currentUser.name }],
      createdAt: new Date().toISOString(), createdBy: currentUser.name
    };
    orders.unshift(newOrder);
    DB.set('orders', orders);
    currentInvoiceOrderId = newOrder.id;
    showToast('Order ' + orderNo + ' created! üéâ', 'success');

    // Auto send WhatsApp
    setTimeout(() => {
      sendWhatsAppMessage(newOrder, 'orderReceived');
    }, 500);
  }

  closeModal('orderModal');
  renderOrders();
  renderCustomers();
  refreshDashboard();
  serviceItemsData = {};
}

function saveOrUpdateCustomer(data) {
  const customers = DB.get('customers') || [];
  const existing = customers.find(c => c.phone === data.phone);
  if (existing) {
    existing.name = data.name;
    existing.phone2 = data.phone2 || existing.phone2;
    existing.address = data.address || existing.address;
    existing.lastVisit = new Date().toISOString();
    existing.totalOrders = (existing.totalOrders || 0) + 1;
  } else {
    customers.push({
      id: 'cust_' + Date.now(), name: data.name, phone: data.phone,
      phone2: data.phone2, address: data.address,
      createdAt: new Date().toISOString(), lastVisit: new Date().toISOString(),
      totalOrders: 1
    });
  }
  DB.set('customers', customers);
}

function saveItemsToServices(serviceItemsData) {
  const services = DB.get('services') || [];
  Object.entries(serviceItemsData).forEach(([serviceId, items]) => {
    const svc = services.find(s => s.id === serviceId);
    if (!svc) return;
    if (!svc.items) svc.items = [];
    items.forEach(item => {
      if (!item.name || !item.price) return;
      const existing = svc.items.find(i => i.name.toLowerCase() === item.name.toLowerCase());
      if (existing) { existing.price = item.price; }
      else { svc.items.push({ name: item.name, price: parseFloat(item.price) }); }
    });
  });
  DB.set('services', services);
}

// ============================================================
// ORDER DETAIL
// ============================================================
function showOrderDetail(orderId) {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;

  const balance = (order.totalAmount||0) - (order.paidAmount||0);
  const overdue = isOverdue(order);

  const statusOptions = ['received','inprogress','ready','delivered','cancelled'];
  const isAdmin = currentUser.role === 'admin';
  const isOperatorPlus = isAdmin || currentUser.role === 'operator';

  let servicesHtml = (order.services||[]).map(svc => `
    <div style="margin-bottom:10px;">
      <div style="font-weight:700;font-size:13px;color:var(--orange);margin-bottom:5px;">${svc.serviceName}</div>
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <tr style="background:var(--card2);">
          <th style="padding:5px 8px;text-align:left;">Item</th>
          <th style="padding:5px 8px;text-align:center;">Qty</th>
          <th style="padding:5px 8px;text-align:right;">Price</th>
          <th style="padding:5px 8px;text-align:right;">Sub</th>
        </tr>
        ${(svc.items||[]).map(item => `<tr>
          <td style="padding:5px 8px;border-bottom:1px solid var(--border);">${item.name||'-'}</td>
          <td style="padding:5px 8px;text-align:center;border-bottom:1px solid var(--border);">${item.qty||1}</td>
          <td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border);">‚Çπ${item.price||0}</td>
          <td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border);font-weight:700;">‚Çπ${((item.qty||1)*(item.price||0)).toFixed(0)}</td>
        </tr>`).join('')}
        <tr><td colspan="3" style="padding:5px 8px;font-weight:700;text-align:right;">Service Total:</td>
          <td style="padding:5px 8px;text-align:right;font-weight:800;color:var(--orange);">‚Çπ${(svc.serviceTotal||0).toFixed(0)}</td></tr>
      </table>
    </div>`).join('');

  let statusHistoryHtml = (order.statusHistory||[]).map(h => `
    <div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--border);">
      <span class="status-badge ${getStatusClass(h.status)}" style="flex-shrink:0;">${getStatusLabel(h.status)}</span>
      <div style="flex:1;">
        <div style="font-size:12px;color:var(--text2);">${formatDateTime(h.changedAt)}</div>
        <div style="font-size:11px;color:var(--text3);">by ${h.changedBy}</div>
      </div>
    </div>`).join('');

  const html = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div>
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:20px;color:var(--orange);">${order.orderNo}</div>
        <div style="font-size:12px;color:var(--text2);">${formatDateTime(order.createdAt)}</div>
      </div>
      <span class="status-badge ${getStatusClass(order.status)}" style="font-size:13px;padding:6px 14px;">${getStatusLabel(order.status)}</span>
    </div>

    ${overdue && order.status !== 'delivered' && order.status !== 'cancelled' ? '<div style="background:rgba(244,67,54,0.1);border:1px solid rgba(244,67,54,0.3);border-radius:10px;padding:10px 12px;margin-bottom:12px;color:var(--danger);font-weight:700;font-size:13px;">üö® This order is OVERDUE!</div>' : ''}

    <div style="background:var(--card2);border-radius:12px;padding:14px;margin-bottom:12px;">
      <div style="font-weight:700;margin-bottom:8px;color:var(--text2);font-size:12px;text-transform:uppercase;">Customer</div>
      <div style="font-weight:700;font-size:15px;">${order.customerName}</div>
      <div style="font-size:13px;color:var(--text2);">üìû <a href="tel:${order.customerPhone}" style="color:var(--info);text-decoration:none;">${order.customerPhone}</a></div>
      ${order.customerPhone2 ? `<div style="font-size:13px;color:var(--text2);">üìû ${order.customerPhone2}</div>` : ''}
      ${order.customerAddress ? `<div style="font-size:12px;color:var(--text3);">üìç ${order.customerAddress}</div>` : ''}
      <div style="margin-top:6px;display:flex;gap:8px;">
        <span style="font-size:12px;">üìÖ Due: <strong style="${overdue?'color:var(--danger)':''}">${formatDate(order.dueDate)}</strong></span>
      </div>
    </div>

    <div style="margin-bottom:12px;">
      <div style="font-weight:700;margin-bottom:8px;color:var(--text2);font-size:12px;text-transform:uppercase;">Services & Items</div>
      ${servicesHtml}
    </div>

    <div style="background:var(--dark);border-radius:12px;padding:14px;margin-bottom:12px;color:white;">
      <div class="inv-total-row"><span>Total Amount</span><strong>‚Çπ${(order.totalAmount||0).toFixed(2)}</strong></div>
      <div class="inv-total-row"><span>Advance Paid</span><strong>‚Çπ${(order.paidAmount||0).toFixed(2)}</strong></div>
      <div class="inv-total-row" style="color:${balance>0?'#ff8a80':'#69f0ae'};font-weight:800;">
        <span>${balance>0?'Balance Due':'Fully Paid'}</span>
        <strong>‚Çπ${balance.toFixed(2)}</strong>
      </div>
      <div style="font-size:11px;opacity:0.6;margin-top:6px;">Mode: ${order.paymentMode==='upi'?'UPI (GPay/PhonePe)':'Cash'}</div>
    </div>

    ${balance > 0 && isOperatorPlus ? `<div style="margin-bottom:12px;">
      <div style="font-weight:700;margin-bottom:8px;color:var(--text2);font-size:12px;text-transform:uppercase;">üí∞ Collect Payment</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="flex:1;">
            <label style="font-size:10px;color:var(--text3);font-weight:600;display:block;margin-bottom:3px;">AMOUNT (‚Çπ)</label>
            <input type="number" id="collectAmount" value="${balance.toFixed(2)}" min="0" step="0.01"
              style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:15px;font-weight:700;outline:none;">
          </div>
          <div>
            <label style="font-size:10px;color:var(--text3);font-weight:600;display:block;margin-bottom:3px;">MODE</label>
            <select id="collectMode" style="padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;outline:none;">
              <option value="cash">üíµ Cash</option>
              <option value="upi">üì± UPI</option>
            </select>
          </div>
        </div>
        <button class="btn btn-success btn-full" onclick="collectPayment('${order.id}')">
          üí∞ Collect Payment
        </button>
      </div>
    </div>` : ''}

    ${isOperatorPlus ? `<div style="margin-bottom:12px;">
      <div style="font-weight:700;margin-bottom:8px;color:var(--text2);font-size:12px;text-transform:uppercase;">Update Status</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">
        ${statusOptions.filter(s => s !== order.status).map(s => `
          <button class="btn btn-secondary btn-sm"
            onclick="updateOrderStatus('${order.id}','${s}')">
            ‚Üí ${getStatusLabel(s)}
          </button>`).join('')}
      </div>
    </div>` : ''}

    ${order.notes ? `<div style="background:rgba(255,107,0,0.08);border-radius:10px;padding:12px;margin-bottom:12px;">
      <div style="font-size:11px;font-weight:700;color:var(--orange);margin-bottom:4px;">NOTES</div>
      <div style="font-size:13px;">${order.notes}</div>
    </div>` : ''}

    <div>
      <div style="font-weight:700;margin-bottom:8px;color:var(--text2);font-size:12px;text-transform:uppercase;">Status History</div>
      ${statusHistoryHtml}
    </div>`;

  document.getElementById('orderDetailTitle').textContent = 'Order ' + order.orderNo;
  document.getElementById('orderDetailBody').innerHTML = html;

  // TOP ROW: Share on WhatsApp + Share Invoice
  const row1 = [];
  row1.push(`<button class="btn btn-success" style="flex:1;padding:8px 10px;font-size:13px;" onclick="shareOrderWhatsAppText('${order.id}')">üí¨ Share on WhatsApp</button>`);
  row1.push(`<button class="btn btn-info" style="flex:1;padding:8px 10px;font-size:13px;" onclick="shareOrderInvoiceImage('${order.id}')">üìÑ Share Invoice</button>`);
  
  // BOTTOM ROW: PDF + Edit + Delete
  const row2 = [];
  row2.push(`<button class="btn btn-primary" style="flex:1;padding:8px 10px;font-size:13px;" onclick="downloadOrderPDF('${order.id}')">‚¨áÔ∏è PDF</button>`);
  if (isOperatorPlus) row2.push(`<button class="btn btn-secondary" style="flex:1;padding:8px 10px;font-size:13px;" onclick="showEditOrder('${order.id}')">‚úèÔ∏è Edit</button>`);
  if (isAdmin) row2.push(`<button class="btn btn-danger" style="flex:0.5;padding:8px 10px;font-size:13px;" onclick="deleteOrder('${order.id}')">üóë</button>`);

  document.getElementById('orderDetailFooter').innerHTML = 
    `<div style="display:flex;flex-direction:column;gap:8px;width:100%;">
      <div style="display:flex;gap:8px;">${row1.join('')}</div>
      <div style="display:flex;gap:8px;">${row2.join('')}</div>
    </div>`;
  openModal('orderDetailModal');
}

function updateOrderStatus(orderId, newStatus) {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;

  order.status = newStatus;
  if (!order.statusHistory) order.statusHistory = [];
  order.statusHistory.push({ status: newStatus, changedAt: new Date().toISOString(), changedBy: currentUser.name });
  order.updatedAt = new Date().toISOString();

  DB.set('orders', orders);
  showToast('Status updated to ' + getStatusLabel(newStatus) + ' ‚úÖ', 'success');
  closeModal('orderDetailModal');
  renderOrders();
  refreshDashboard();
  renderDueDatePage();

  // Auto WhatsApp for ready status
  if (newStatus === 'ready') {
    setTimeout(() => sendWhatsAppMessage(order, 'orderReady'), 500);
  }
}

function collectPayment(orderId) {
  const amount = parseFloat(document.getElementById('collectAmount').value) || 0;
  const mode = document.getElementById('collectMode').value;
  if (amount <= 0) { showToast('Enter valid amount', 'error'); return; }

  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;

  order.paidAmount = (order.paidAmount || 0) + amount;
  if (order.paidAmount > order.totalAmount) order.paidAmount = order.totalAmount;
  order.paymentMode = mode;
  if (!order.paymentHistory) order.paymentHistory = [];
  order.paymentHistory.push({ amount, mode, date: new Date().toISOString(), by: currentUser.name });

  DB.set('orders', orders);
  showToast('Payment of ‚Çπ' + amount.toFixed(2) + ' collected! üí∞', 'success');
  closeModal('orderDetailModal');
  refreshDashboard();
  renderOrders();
}

function deleteOrder(orderId) {
  closeModal('orderDetailModal');
  showConfirm('Delete Order', 'Are you sure you want to permanently delete this order? This cannot be undone.', 'üóëÔ∏è', () => {
    const orders = DB.get('orders') || [];
    DB.set('orders', orders.filter(o => o.id !== orderId));
    showToast('Order deleted', 'warning');
    renderOrders();
    refreshDashboard();
  });
}

// ============================================================
// QUICK SHARE FROM CARD
// ============================================================
function quickShareWhatsAppText(orderId) {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  
  // Send text message only
  const templateKey = order.status === 'ready' ? 'orderReady' : 'orderReceived';
  sendWhatsAppMessage(order, templateKey);
  
  // Mark as sent
  markWhatsAppSent(orderId);
  renderOrders();
  renderDueDatePage();
  refreshDashboard();
}

function quickShareInvoiceImage(orderId) {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  
  // Generate and share invoice image
  currentInvoiceOrderId = orderId;
  showInvoice(orderId);
  setTimeout(() => {
    shareInvoiceImageOnly();
    closeModal('invoiceModal');
  }, 800);
}

// ============================================================
// WHATSAPP
// ============================================================
function shareOrderWhatsAppText(orderId) {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  
  const templateKey = order.status === 'ready' ? 'orderReady' : 'orderReceived';
  sendWhatsAppMessage(order, templateKey);
  markWhatsAppSent(orderId);
  showToast('Opening WhatsApp... üí¨', 'success');
}

function shareOrderInvoiceImage(orderId) {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  
  currentInvoiceOrderId = orderId;
  showInvoice(orderId);
  setTimeout(() => {
    shareInvoiceImageOnly();
  }, 800);
}

function downloadOrderPDF(orderId) {
  currentInvoiceOrderId = orderId;
  showInvoice(orderId);
  setTimeout(() => {
    downloadInvoicePDF();
    closeModal('invoiceModal');
  }, 800);
}

function sendWhatsAppMessage(order, templateKey) {
  const templates = DB.get('whatsappTemplates') || {};
  let template = templates[templateKey] || '';
  const shop = DB.get('shopSettings') || {};
  const balance = (order.totalAmount||0) - (order.paidAmount||0);
  const serviceNames = (order.services||[]).map(s=>s.serviceName).join(', ');

  let msg = template
    .replace(/{customerName}/g, order.customerName)
    .replace(/{orderNo}/g, order.orderNo)
    .replace(/{services}/g, serviceNames)
    .replace(/{totalAmount}/g, (order.totalAmount||0).toFixed(2))
    .replace(/{advancePaid}/g, (order.paidAmount||0).toFixed(2))
    .replace(/{balanceDue}/g, balance.toFixed(2))
    .replace(/{dueDate}/g, formatDate(order.dueDate))
    .replace(/{shopName}/g, shop.name||'TurboWash Laundry')
    .replace(/{shopPhone}/g, shop.phone||'');

  const phone = order.customerPhone.replace(/[^0-9]/g,'');
  const url = `https://wa.me/${phone.startsWith('91')?phone:'91'+phone}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}

function sendWhatsAppFromDetail(orderId) {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  const templateKey = order.status === 'ready' ? 'orderReady' : 'orderReceived';
  sendWhatsAppMessage(order, templateKey);
  const counts = DB.get('shareCounts') || {};
  counts['wa_'+orderId] = (counts['wa_'+orderId] || 0) + 1;
  DB.set('shareCounts', counts);
  setTimeout(() => { renderOrders(); renderDueDatePage(); refreshDashboard(); }, 300);
}

// ============================================================
// INVOICE
// ============================================================
function trackInvoiceView(orderId) {
  showInvoice(orderId);
  const counts = DB.get('shareCounts') || {};
  counts['inv_'+orderId] = (counts['inv_'+orderId] || 0) + 1;
  DB.set('shareCounts', counts);
  setTimeout(() => { renderOrders(); renderDueDatePage(); refreshDashboard(); }, 300);
}

function showInvoice(orderId) {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  currentInvoiceOrderId = orderId;

  const shop = DB.get('shopSettings') || {};
  const balance = (order.totalAmount||0) - (order.paidAmount||0);
  const logoB64 = DB.get('logoB64');

  let servicesHtml = (order.services||[]).map(svc => `
    <tr><td colspan="5" style="padding:4px 8px;font-weight:700;font-size:12px;color:var(--orange);background:rgba(255,107,0,0.05);">${svc.serviceName}</td></tr>
    ${(svc.items||[]).map(item => {
      const disc = parseFloat(item.discount)||0;
      const sub = Math.max(0,((parseFloat(item.qty)||1)*(parseFloat(item.price)||0))-disc);
      return `<tr>
        <td style="padding:4px 8px;">${item.name||'-'}</td>
        <td style="padding:4px 8px;text-align:center;">${item.qty||1}</td>
        <td style="padding:4px 8px;text-align:right;">‚Çπ${item.price||0}</td>
        <td style="padding:4px 8px;text-align:right;color:#0277BD;">${disc>0?'-‚Çπ'+disc:'-'}</td>
        <td style="padding:4px 8px;text-align:right;font-weight:700;">‚Çπ${sub.toFixed(0)}</td>
      </tr>`;}).join('')}
  `).join('');

  // Determine payment stamp
  const isFullyPaid = balance <= 0;
  const isPartial = (order.paidAmount||0) > 0 && balance > 0;
  const stampHtml = isFullyPaid 
    ? `<div style="position:absolute;top:40%;left:50%;transform:translate(-50%,-50%) rotate(-25deg);font-size:44px;font-weight:900;border:5px solid #00C853;border-radius:8px;padding:4px 14px;opacity:0.15;letter-spacing:4px;color:#00C853;pointer-events:none;white-space:nowrap;">PAID</div>`
    : isPartial
    ? `<div style="position:absolute;top:40%;left:50%;transform:translate(-50%,-50%) rotate(-25deg);font-size:28px;font-weight:900;border:4px solid #29B6F6;border-radius:8px;padding:4px 10px;opacity:0.18;letter-spacing:2px;color:#29B6F6;pointer-events:none;white-space:nowrap;">PARTIAL PAID</div>`
    : `<div style="position:absolute;top:40%;left:50%;transform:translate(-50%,-50%) rotate(-25deg);font-size:44px;font-weight:900;border:5px solid #F44336;border-radius:8px;padding:4px 14px;opacity:0.15;letter-spacing:4px;color:#F44336;pointer-events:none;white-space:nowrap;">UNPAID</div>`;

  const html = `
    <div class="invoice-preview" id="invoiceContent" style="position:relative;overflow:hidden;">
      ${stampHtml}
      <div class="inv-header">
        <h2>${shop.name}</h2>
        <p>${shop.address}</p>
        <p>üìû ${shop.phone} | üïê ${shop.hours}</p>
      </div>
      <div class="inv-row"><span>Invoice No:</span><strong>${order.orderNo}</strong></div>
      <div class="inv-row"><span>Date:</span><strong>${formatDate(order.orderDate||order.createdAt)}</strong></div>
      <div class="inv-row"><span>Due Date:</span><strong>${formatDate(order.dueDate)}</strong></div>
      <hr class="inv-divider">
      <div class="inv-row"><span>Customer:</span><strong>${order.customerName}</strong></div>
      <div class="inv-row"><span>Phone:</span><strong>${order.customerPhone}</strong></div>
      ${order.customerAddress ? `<div class="inv-row"><span>Address:</span><strong>${order.customerAddress}</strong></div>` : ''}
      <hr class="inv-divider">
      <table class="inv-table">
        <thead><tr>
          <th>Item</th><th style="text-align:center;">Qty</th>
          <th style="text-align:right;">Price</th><th style="text-align:right;color:#0277BD;">Disc</th><th style="text-align:right;">Sub</th>
        </tr></thead>
        <tbody>${servicesHtml}</tbody>
      </table>
      <div class="inv-total">
        <div class="inv-total-row"><span>Total Amount</span><strong>‚Çπ${(order.totalAmount||0).toFixed(2)}</strong></div>
        <div class="inv-total-row"><span>Advance Paid</span><strong>‚Çπ${(order.paidAmount||0).toFixed(2)}</strong></div>
        <div class="inv-total-row main"><span>${balance>0?'Balance Due':'Amount Paid'}</span><strong>‚Çπ${balance>0?balance.toFixed(2):(order.totalAmount||0).toFixed(2)}</strong></div>
        <div style="font-size:11px;opacity:0.6;margin-top:4px;">Payment Mode: ${order.paymentMode==='upi'?'UPI (GPay/PhonePe)':'Cash'}</div>
      </div>
      ${order.notes ? `<div style="margin-top:10px;padding:10px;background:rgba(255,107,0,0.08);border-radius:8px;font-size:12px;"><strong>Note:</strong> ${order.notes}</div>` : ''}
      <div class="inv-footer">
        <p>Thank you for choosing ${shop.name}! üôè</p>
        <p>Visit us again | ${shop.hours}</p>
      </div>
    </div>`;

  document.getElementById('invoiceBody').innerHTML = html;
  closeModal('orderDetailModal');
  openModal('invoiceModal');
}

function shareInvoiceWhatsApp() {
  if (!currentInvoiceOrderId) return;
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === currentInvoiceOrderId);
  if (!order) return;
  sendWhatsAppMessage(order, order.status === 'ready' ? 'orderReady' : 'orderReceived');
  const counts = DB.get('shareCounts') || {};
  counts['wa_'+currentInvoiceOrderId] = (counts['wa_'+currentInvoiceOrderId] || 0) + 1;
  DB.set('shareCounts', counts);
  setTimeout(() => { renderOrders(); renderDueDatePage(); refreshDashboard(); }, 300);
}

function downloadInvoicePDF() {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === currentInvoiceOrderId);
  if (!order) { showToast('No order selected', 'error'); return; }

  const shop = DB.get('shopSettings') || {};
  const logoB64 = DB.get('logoB64') || '';
  const balance = Math.max(0, (order.totalAmount||0) - (order.paidAmount||0));
  const isFullyPaid = balance <= 0;
  const isPartial = (order.paidAmount||0) > 0 && balance > 0;

  showToast('Generating PDF... ‚è≥', '');

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'a5' });

    const pw = doc.internal.pageSize.getWidth();
    let y = 0;
    const margin = 10;
    const cw = pw - margin * 2;

    // ---- HEADER BACKGROUND ----
    doc.setFillColor(26, 26, 46);
    doc.roundedRect(0, 0, pw, 38, 0, 0, 'F');

    // ---- SHOP NAME ----
    doc.setTextColor(255, 107, 0);
    doc.setFontSize(13);
    doc.setFont('helvetica', 'bold');
    doc.text(shop.name || 'TurboWash Laundry', pw/2, 14, {align:'center'});

    doc.setTextColor(200, 200, 220);
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.text(shop.address || '', pw/2, 19, {align:'center', maxWidth:cw});
    doc.text((shop.phone||'') + '  |  ' + (shop.hours||''), pw/2, 24, {align:'center'});

    y = 42;

    // ---- ORDER INFO ----
    doc.setFillColor(248, 249, 255);
    doc.roundedRect(margin, y, cw, 22, 2, 2, 'F');
    doc.setDrawColor(232, 234, 240);
    doc.roundedRect(margin, y, cw, 22, 2, 2, 'S');

    doc.setTextColor(85, 85, 119);
    doc.setFontSize(7.5);
    doc.setFont('helvetica', 'normal');
    const col1x = margin + 3;
    const col2x = pw/2 + 3;

    doc.text('Invoice No:', col1x, y+5);
    doc.text('Date:', col2x, y+5);
    doc.setTextColor(26, 26, 46);
    doc.setFont('helvetica', 'bold');
    doc.text(order.orderNo || '', col1x + 22, y+5);
    doc.text(formatDate(order.orderDate||order.createdAt), col2x + 13, y+5);

    doc.setFont('helvetica', 'normal');
    doc.setTextColor(85, 85, 119);
    doc.text('Customer:', col1x, y+11);
    doc.text('Due Date:', col2x, y+11);
    doc.setTextColor(26, 26, 46);
    doc.setFont('helvetica', 'bold');
    doc.text(order.customerName || '', col1x + 22, y+11);
    doc.setTextColor(255, 107, 0);
    doc.text(formatDate(order.dueDate), col2x + 13, y+11);

    doc.setFont('helvetica', 'normal');
    doc.setTextColor(85, 85, 119);
    doc.text('Phone:', col1x, y+17);
    doc.setTextColor(26, 26, 46);
    doc.setFont('helvetica', 'bold');
    doc.text(order.customerPhone || '', col1x + 22, y+17);

    if (order.customerAddress) {
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(85, 85, 119);
      doc.text('Address:', col2x, y+17);
      doc.setTextColor(26, 26, 46);
      doc.setFont('helvetica', 'bold');
      const addrTxt = doc.splitTextToSize(order.customerAddress, cw/2 - 15);
      doc.text(addrTxt[0] || '', col2x + 16, y+17);
    }

    y += 26;

    // ---- ITEMS TABLE ----
    doc.setFillColor(255, 107, 0);
    doc.roundedRect(margin, y, cw, 7, 1, 1, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(7);
    doc.setFont('helvetica', 'bold');
    const colW = [cw*0.38, cw*0.12, cw*0.16, cw*0.14, cw*0.20];
    const colX = [margin+2, margin+colW[0]+2, margin+colW[0]+colW[1]+2, margin+colW[0]+colW[1]+colW[2]+2, margin+colW[0]+colW[1]+colW[2]+colW[3]+2];
    doc.text('ITEM', colX[0], y+4.5);
    doc.text('QTY', colX[1], y+4.5);
    doc.text('PRICE', colX[2], y+4.5);
    doc.text('DISC', colX[3], y+4.5);
    doc.text('SUB', colX[4], y+4.5);
    y += 8;

    let rowBg = false;
    (order.services||[]).forEach(svc => {
      // Service name row
      doc.setFillColor(255, 248, 240);
      doc.rect(margin, y, cw, 6, 'F');
      doc.setTextColor(255, 107, 0);
      doc.setFontSize(7.5);
      doc.setFont('helvetica', 'bold');
      doc.text(svc.serviceName || '', margin+2, y+4);
      y += 6;

      (svc.items||[]).forEach(item => {
        const disc = parseFloat(item.discount)||0;
        const sub = Math.max(0, ((parseFloat(item.qty)||1)*(parseFloat(item.price)||0))-disc);

        if (rowBg) {
          doc.setFillColor(248, 249, 255);
          doc.rect(margin, y, cw, 6, 'F');
        }
        rowBg = !rowBg;

        doc.setTextColor(26, 26, 46);
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        const itemName = doc.splitTextToSize(item.name||'-', colW[0]-3);
        doc.text(itemName[0]||'', colX[0], y+4);
        doc.text(String(item.qty||1), colX[1], y+4);
        doc.text('Rs.'+String(item.price||0), colX[2], y+4);
        doc.setTextColor(2, 119, 189);
        doc.text(disc>0?'-Rs.'+disc:'-', colX[3], y+4);
        doc.setTextColor(255, 107, 0);
        doc.setFont('helvetica', 'bold');
        doc.text('Rs.'+sub.toFixed(0), colX[4], y+4);
        y += 6;

        if (y > doc.internal.pageSize.getHeight() - 40) {
          doc.addPage();
          y = 10;
        }
      });
    });

    // Divider
    doc.setDrawColor(232, 234, 240);
    doc.line(margin, y+2, pw-margin, y+2);
    y += 6;

    // ---- TOTALS BOX ----
    const totH = order.notes ? 34 : 28;
    doc.setFillColor(26, 26, 46);
    doc.roundedRect(margin, y, cw, totH, 3, 3, 'F');

    doc.setTextColor(180, 180, 200);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.text('Total Amount:', margin+4, y+7);
    doc.text('Advance Paid:', margin+4, y+13);
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.text('Rs.'+((order.totalAmount||0).toFixed(2)), pw-margin-4, y+7, {align:'right'});
    doc.text('Rs.'+((order.paidAmount||0).toFixed(2)), pw-margin-4, y+13, {align:'right'});

    doc.setDrawColor(80, 80, 100);
    doc.line(margin+3, y+16, pw-margin-3, y+16);

    const balLabel = balance > 0 ? 'Balance Due:' : 'Amount Paid:';
    const balVal = balance > 0 ? balance.toFixed(2) : (order.totalAmount||0).toFixed(2);
    doc.setTextColor(255, 215, 0);
    doc.setFontSize(10);
    doc.text(balLabel, margin+4, y+23);
    doc.text('Rs.'+balVal, pw-margin-4, y+23, {align:'right'});

    if (order.notes) {
      doc.setTextColor(200, 200, 200);
      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      doc.text('Note: ' + order.notes, margin+4, y+29, {maxWidth: cw-8});
    }

    y += totH + 4;

    // ---- PAYMENT STAMP ----
    const stampText = isFullyPaid ? 'PAID' : isPartial ? 'PARTIAL' : 'UNPAID';
    const stampColor = isFullyPaid ? [0,200,83] : isPartial ? [41,182,246] : [244,67,54];
    doc.saveGraphicsState();
    doc.setGState(new doc.GState({opacity:0.15}));
    doc.setTextColor(...stampColor);
    doc.setFontSize(isPartial ? 28 : 38);
    doc.setFont('helvetica', 'bold');
    doc.text(stampText, pw/2, doc.internal.pageSize.getHeight()/2, {align:'center', angle:30});
    doc.restoreGraphicsState();

    // ---- FOOTER ----
    const fh = doc.internal.pageSize.getHeight();
    doc.setDrawColor(232, 234, 240);
    doc.line(margin, fh-14, pw-margin, fh-14);
    doc.setTextColor(150, 150, 170);
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.text('Thank you for choosing ' + (shop.name||'TurboWash Laundry') + '!', pw/2, fh-10, {align:'center'});
    doc.text((shop.hours||'') + '  |  Visit us again', pw/2, fh-6, {align:'center'});

    // ---- SAVE PDF ----
    const filename = 'TurboWash_' + (order.orderNo||'Invoice') + '.pdf';
    doc.save(filename);
    showToast('PDF downloaded! ‚úÖ', 'success');

  } catch(err) {
    console.error('PDF error:', err);
    showToast('PDF error: ' + err.message, 'error');
  }
}


function printInvoice() { downloadInvoicePDF(); }

// ============================================================
// FIX 2: SHARE INVOICE IMAGE DIRECTLY VIA WHATSAPP
// ============================================================
function shareInvoiceAsImage() {
  const content = document.getElementById('invoiceContent');
  if (!content) { showToast('Invoice not loaded', 'error'); return; }

  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === currentInvoiceOrderId);
  if (!order) { showToast('Order not found', 'error'); return; }

  showToast('Generating invoice image... ‚è≥', '');

  if (typeof html2canvas !== 'undefined') {
    html2canvas(content, {
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      allowTaint: true,
      logging: false
    }).then(canvas => {
      canvas.toBlob(blob => {
        if (!blob) { 
          showToast('Failed to generate image', 'error'); 
          return; 
        }

        // ALWAYS download image and open WhatsApp (no share sheet)
        openWhatsAppWithImage(order, canvas);
      }, 'image/png', 0.95);
    }).catch(err => {
      console.error('html2canvas error:', err);
      showToast('Sending text message via WhatsApp', 'warning');
      sendWhatsAppWithTracking(order);
    });
  } else {
    sendWhatsAppWithTracking(order);
  }
}

function openWhatsAppWithImage(order, canvas) {
  // Prepare message based on status
  const templates = DB.get('whatsappTemplates') || {};
  const templateKey = order.status === 'ready' ? 'orderReady' : 'orderReceived';
  const shop = DB.get('shopSettings') || {};
  const balance = Math.max(0, (order.totalAmount||0) - (order.paidAmount||0));
  const serviceNames = (order.services||[]).map(s=>s.serviceName).join(', ');

  let msg = (templates[templateKey] || '')
    .replace(/{customerName}/g, order.customerName)
    .replace(/{orderNo}/g, order.orderNo)
    .replace(/{services}/g, serviceNames)
    .replace(/{totalAmount}/g, (order.totalAmount||0).toFixed(2))
    .replace(/{advancePaid}/g, (order.paidAmount||0).toFixed(2))
    .replace(/{balanceDue}/g, balance.toFixed(2))
    .replace(/{dueDate}/g, formatDate(order.dueDate))
    .replace(/{shopName}/g, shop.name||'TurboWash Laundry')
    .replace(/{shopPhone}/g, shop.phone||'');

  // Add tracking link
  const trackingUrl = window.location.origin + '/track/' + order.orderNo;
  msg += '\n\nüìç Track your order: ' + trackingUrl;

  // Try Web Share API first (works on Android, shares image + text together)
  canvas.toBlob(blob => {
    if (!blob) {
      fallbackWhatsAppOnly(order, msg);
      return;
    }

    const file = new File([blob], 'Invoice_' + order.orderNo + '.png', { type: 'image/png' });

    // Check if Web Share API with files is supported
    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
      navigator.share({
        files: [file],
        text: msg,
        title: 'Invoice ' + order.orderNo
      }).then(() => {
        markWhatsAppSent(order.id);
        showToast('Shared successfully! ‚úÖ', 'success');
      }).catch(err => {
        if (err.name !== 'AbortError') {
          console.error('Share failed:', err);
          fallbackDownloadAndWhatsApp(order, canvas, msg);
        }
      });
    } else {
      // Fallback: Download image + open WhatsApp
      fallbackDownloadAndWhatsApp(order, canvas, msg);
    }
  }, 'image/png', 0.95);
}

function fallbackDownloadAndWhatsApp(order, canvas, msg) {
  // Download image
  const link = document.createElement('a');
  link.download = 'TurboWash_Invoice_' + order.orderNo + '.png';
  link.href = canvas.toDataURL('image/png', 0.95);
  link.click();

  // Open WhatsApp with message
  setTimeout(() => {
    const phone = order.customerPhone.replace(/[^0-9]/g,'');
    const waPhone = phone.startsWith('91') ? phone : '91' + phone;
    const url = `https://wa.me/${waPhone}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
    markWhatsAppSent(order.id);
    showToast('Image downloaded! Open WhatsApp and attach it üì∏', 'info');
  }, 800);
}

function fallbackWhatsAppOnly(order, msg) {
  // Just open WhatsApp with text (no image)
  const phone = order.customerPhone.replace(/[^0-9]/g,'');
  const waPhone = phone.startsWith('91') ? phone : '91' + phone;
  const url = `https://wa.me/${waPhone}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
  markWhatsAppSent(order.id);
  showToast('Opened WhatsApp üí¨', 'success');
}

function shareInvoiceImageOnly() {
  const content = document.getElementById('invoiceContent');
  if (!content) { showToast('Invoice not loaded', 'error'); return; }

  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === currentInvoiceOrderId);
  if (!order) { showToast('Order not found', 'error'); return; }

  showToast('Generating invoice image... ‚è≥', '');

  if (typeof html2canvas !== 'undefined') {
    html2canvas(content, {
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      allowTaint: true,
      logging: false
    }).then(canvas => {
      canvas.toBlob(blob => {
        if (!blob) { 
          showToast('Failed to generate image', 'error'); 
          return; 
        }

        const file = new File([blob], 'TurboWash_Invoice_' + order.orderNo + '.png', { type: 'image/png' });

        // Use Web Share API to share image
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({
            files: [file],
            title: 'Invoice ' + order.orderNo
          }).then(() => {
            showToast('Invoice shared! ‚úÖ', 'success');
            closeModal('invoiceModal');
          }).catch(err => {
            if (err.name !== 'AbortError') {
              // Fallback: download
              const link = document.createElement('a');
              link.download = 'TurboWash_Invoice_' + order.orderNo + '.png';
              link.href = canvas.toDataURL('image/png', 0.95);
              link.click();
              showToast('Invoice downloaded! üì∏', 'success');
              closeModal('invoiceModal');
            }
          });
        } else {
          // Fallback: download
          const link = document.createElement('a');
          link.download = 'TurboWash_Invoice_' + order.orderNo + '.png';
          link.href = canvas.toDataURL('image/png', 0.95);
          link.click();
          showToast('Invoice downloaded! üì∏', 'success');
          closeModal('invoiceModal');
        }
      }, 'image/png', 0.95);
    }).catch(err => {
      console.error('html2canvas error:', err);
      showToast('Failed to generate invoice image', 'error');
    });
  } else {
    showToast('Image generation not available', 'error');
  }
}

function sendWhatsAppWithTracking(order) {
  const templates = DB.get('whatsappTemplates') || {};
  const templateKey = order.status === 'ready' ? 'orderReady' : 'orderReceived';
  const shop = DB.get('shopSettings') || {};
  const balance = Math.max(0, (order.totalAmount||0) - (order.paidAmount||0));
  const serviceNames = (order.services||[]).map(s=>s.serviceName).join(', ');

  let msg = (templates[templateKey] || '')
    .replace(/{customerName}/g, order.customerName)
    .replace(/{orderNo}/g, order.orderNo)
    .replace(/{services}/g, serviceNames)
    .replace(/{totalAmount}/g, (order.totalAmount||0).toFixed(2))
    .replace(/{advancePaid}/g, (order.paidAmount||0).toFixed(2))
    .replace(/{balanceDue}/g, balance.toFixed(2))
    .replace(/{dueDate}/g, formatDate(order.dueDate))
    .replace(/{shopName}/g, shop.name||'TurboWash Laundry')
    .replace(/{shopPhone}/g, shop.phone||'');

  const trackingUrl = window.location.origin + '/track/' + order.orderNo;
  msg += '\n\nüìç Track your order: ' + trackingUrl;

  const phone = order.customerPhone.replace(/[^0-9]/g,'');
  const waPhone = phone.startsWith('91') ? phone : '91' + phone;
  const url = `https://wa.me/${waPhone}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
  markWhatsAppSent(order.id);
}

function generateAndSendInvoiceWhatsApp(order) {
  // First show invoice to generate the HTML
  showInvoice(order.id);
  
  // Wait for invoice to render, then capture and send
  setTimeout(() => {
    const content = document.getElementById('invoiceContent');
    if (!content || typeof html2canvas === 'undefined') {
      // Fallback to text only
      closeModal('invoiceModal');
      sendWhatsAppWithTracking(order);
      return;
    }

    html2canvas(content, {
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      allowTaint: true,
      logging: false
    }).then(canvas => {
      closeModal('invoiceModal');
      
      // Convert to blob
      canvas.toBlob(blob => {
        if (!blob) {
          sendWhatsAppWithTracking(order);
          return;
        }

        // Download image
        const link = document.createElement('a');
        link.download = 'TurboWash_Invoice_' + order.orderNo + '.png';
        link.href = canvas.toDataURL('image/png', 0.95);
        link.click();

        // Prepare WhatsApp message
        const templates = DB.get('whatsappTemplates') || {};
        const shop = DB.get('shopSettings') || {};
        const balance = Math.max(0, (order.totalAmount||0) - (order.paidAmount||0));
        const serviceNames = (order.services||[]).map(s=>s.serviceName).join(', ');

        let msg = (templates.orderReceived || '')
          .replace(/{customerName}/g, order.customerName)
          .replace(/{orderNo}/g, order.orderNo)
          .replace(/{services}/g, serviceNames)
          .replace(/{totalAmount}/g, (order.totalAmount||0).toFixed(2))
          .replace(/{advancePaid}/g, (order.paidAmount||0).toFixed(2))
          .replace(/{balanceDue}/g, balance.toFixed(2))
          .replace(/{dueDate}/g, formatDate(order.dueDate))
          .replace(/{shopName}/g, shop.name||'TurboWash Laundry')
          .replace(/{shopPhone}/g, shop.phone||'');

        const trackingUrl = window.location.origin + '/track/' + order.orderNo;
        msg += '\n\nüìç Track your order: ' + trackingUrl;

        // Open WhatsApp
        setTimeout(() => {
          const phone = order.customerPhone.replace(/[^0-9]/g,'');
          const waPhone = phone.startsWith('91') ? phone : '91' + phone;
          const url = `https://wa.me/${waPhone}?text=${encodeURIComponent(msg)}`;
          window.open(url, '_blank');
          markWhatsAppSent(order.id);
          showToast('Invoice image downloaded! Attach in WhatsApp üì∏', 'success');
        }, 500);
      }, 'image/png', 0.95);
    }).catch(err => {
      console.error('Invoice generation error:', err);
      closeModal('invoiceModal');
      sendWhatsAppWithTracking(order);
    });
  }, 1000);
}

function markWhatsAppSent(orderId) {
  const orders = DB.get('orders') || [];
  const order = orders.find(o => o.id === orderId);
  if (order) {
    order.lastWhatsAppSent = new Date().toISOString();
    order.whatsAppSentBy = currentUser.name;
    if (!order.notificationsSent) order.notificationsSent = [];
    order.notificationsSent.push({
      type: 'whatsapp',
      status: order.status,
      sentAt: new Date().toISOString(),
      sentBy: currentUser.name
    });
    DB.set('orders', orders);
  }
  // Increment share count
  const counts = DB.get('shareCounts') || {};
  counts['wa_'+orderId] = (counts['wa_'+orderId] || 0) + 1;
  DB.set('shareCounts', counts);
  // Refresh views
  setTimeout(() => { renderOrders(); renderDueDatePage(); refreshDashboard(); }, 300);
}

function fallbackWhatsAppInvoice(order, canvas) {
  // Download image first, then open WhatsApp
  const link = document.createElement('a');
  link.download = 'TurboWash_Invoice_' + order.orderNo + '.png';
  link.href = canvas.toDataURL('image/png', 0.95);
  link.click();

  // Small delay then open WhatsApp with instructions
  setTimeout(() => {
    const phone = order.customerPhone.replace(/[^0-9]/g,'');
    const waPhone = phone.startsWith('91') ? phone : '91' + phone;
    const msg = `Dear ${order.customerName},

Please find your invoice for Order ${order.orderNo} attached.

Thank you for choosing TurboWash Laundry! üß∫`;
    const url = `https://wa.me/${waPhone}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
    showToast('Image downloaded! Attach it in WhatsApp üì∏', 'success');
  }, 800);
}

// ============================================================
// CUSTOMERS PAGE
// ============================================================
function renderCustomers() {
  const customers = DB.get('customers') || [];
  const orders = DB.get('orders') || [];
  const search = (document.getElementById('customerSearch')||{}).value || '';

  let filtered = customers;
  if (search.trim()) {
    const q = search.toLowerCase();
    filtered = filtered.filter(c => c.name.toLowerCase().includes(q) || c.phone.includes(q));
  }
  filtered.sort((a,b) => new Date(b.lastVisit||0) - new Date(a.lastVisit||0));

  const container = document.getElementById('customersList');
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><h3>No customers yet</h3><p>Customers are added automatically when you create orders</p></div>';
    return;
  }

  container.innerHTML = filtered.map(c => {
    const custOrders = orders.filter(o => o.customerPhone === c.phone);
    const balance = custOrders.reduce((sum, o) => sum + Math.max(0, (o.totalAmount||0)-(o.paidAmount||0)), 0);
    const initial = c.name.charAt(0).toUpperCase();
    return `<div class="customer-card" onclick="showCustomerDetail('${c.id}')">
      <div class="customer-avatar">${initial}</div>
      <div class="customer-info">
        <div class="customer-name">${c.name}</div>
        <div class="customer-phone">üìû ${c.phone}</div>
        <div style="font-size:11px;color:var(--text3);">Last visit: ${formatDate(c.lastVisit)}</div>
      </div>
      <div class="customer-stats">
        <div class="customer-orders">${custOrders.length}</div>
        <div style="font-size:10px;color:var(--text3);">orders</div>
        ${balance > 0 ? `<div class="customer-balance">‚Çπ${balance.toFixed(0)} due</div>` : '<div style="font-size:10px;color:var(--success);font-weight:600;">‚úÖ Clear</div>'}
      </div>
    </div>`;
  }).join('');
}

function filterCustomers() { renderCustomers(); }

function showCustomerDetail(customerId) {
  const customers = DB.get('customers') || [];
  const c = customers.find(c => c.id === customerId);
  if (!c) return;
  const orders = DB.get('orders') || [];
  const custOrders = orders.filter(o => o.customerPhone === c.phone).sort((a,b) => new Date(b.createdAt)-new Date(a.createdAt));
  const totalSpent = custOrders.reduce((sum,o) => sum+(o.paidAmount||0), 0);
  const totalDue = custOrders.reduce((sum,o) => sum+Math.max(0,(o.totalAmount||0)-(o.paidAmount||0)), 0);

  const html = `
    <div style="text-align:center;margin-bottom:16px;">
      <div style="width:64px;height:64px;border-radius:20px;background:linear-gradient(135deg,var(--orange),var(--yellow));display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:white;margin:0 auto 8px;font-family:'Nunito',sans-serif;">${c.name.charAt(0).toUpperCase()}</div>
      <div style="font-weight:800;font-size:18px;">${c.name}</div>
      <div><a href="tel:${c.phone}" style="color:var(--info);text-decoration:none;font-size:14px;">üìû ${c.phone}</a></div>
      ${c.phone2 ? `<div style="font-size:13px;color:var(--text2);">üìû ${c.phone2}</div>` : ''}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px;">
      <div style="background:var(--card2);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:20px;color:var(--orange);">${custOrders.length}</div>
        <div style="font-size:10px;color:var(--text2);">Total Orders</div>
      </div>
      <div style="background:var(--card2);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:16px;color:var(--success);">‚Çπ${totalSpent.toFixed(0)}</div>
        <div style="font-size:10px;color:var(--text2);">Total Paid</div>
      </div>
      <div style="background:var(--card2);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:16px;color:var(--danger);">‚Çπ${totalDue.toFixed(0)}</div>
        <div style="font-size:10px;color:var(--text2);">Total Due</div>
      </div>
    </div>
    <div style="font-weight:700;font-size:12px;color:var(--text2);text-transform:uppercase;margin-bottom:8px;">Order History</div>
    ${custOrders.length === 0 ? '<div class="empty-state"><div class="empty-icon">üìã</div><h3>No orders</h3></div>' :
      custOrders.map(o => renderOrderCard(o)).join('')}`;

  showPopup('üë§', c.name, c.phone, html, [
    { label:'New Order', cls:'btn-primary', action:`closePopup();showNewOrderModal({name:'${c.name}',phone:'${c.phone}'})` },
    { label:'üìä Report', cls:'btn-info', action:`closePopup();showCustomerReport('${c.id}')` },
    { label:'Close', cls:'btn-secondary', action:'closePopup()' }
  ]);
}

// ============================================================
// CUSTOMER REPORT
// ============================================================
function showCustomerReportSelector() {
  const customers = DB.get('customers') || [];
  if (customers.length === 0) { showToast('No customers found', 'error'); return; }

  const today = new Date().toISOString().split('T')[0];
  const firstDay = new Date(); firstDay.setDate(1);
  const firstDayStr = firstDay.toISOString().split('T')[0];

  const html = `
    <div class="field">
      <label>Select Customer</label>
      <select id="rpt_customer" style="width:100%;padding:12px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;outline:none;">
        <option value="">-- Select Customer --</option>
        ${customers.sort((a,b)=>a.name.localeCompare(b.name)).map(c=>`<option value="${c.id}">${c.name} (${c.phone})</option>`).join('')}
      </select>
    </div>
    <div class="field-row">
      <div class="field">
        <label>From Date</label>
        <input type="date" id="rpt_from" value="${firstDayStr}" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;outline:none;">
      </div>
      <div class="field">
        <label>To Date</label>
        <input type="date" id="rpt_to" value="${today}" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;outline:none;">
      </div>
    </div>`;

  showPopup('üìä', 'Customer Report', 'Select customer & date range', html, [
    { label:'Generate Report', cls:'btn-primary', action:'generateCustomerReport()' },
    { label:'Cancel', cls:'btn-secondary', action:'closePopup()' }
  ]);
}

function showCustomerReport(customerId) {
  const customers = DB.get('customers') || [];
  const c = customers.find(c => c.id === customerId);
  if (!c) return;

  const today = new Date().toISOString().split('T')[0];
  const firstDay = new Date(); firstDay.setDate(1);
  const firstDayStr = firstDay.toISOString().split('T')[0];

  const html = `
    <div style="background:linear-gradient(135deg,var(--orange),var(--yellow));border-radius:12px;padding:14px;margin-bottom:12px;color:white;display:flex;align-items:center;gap:12px;">
      <div style="width:48px;height:48px;border-radius:14px;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;font-family:'Nunito',sans-serif;">${c.name.charAt(0)}</div>
      <div>
        <div style="font-weight:800;font-size:16px;">${c.name}</div>
        <div style="font-size:12px;opacity:0.85;">üìû ${c.phone}</div>
      </div>
    </div>
    <div class="field-row">
      <div class="field">
        <label>From Date</label>
        <input type="date" id="rpt_from" value="${firstDayStr}" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;outline:none;">
      </div>
      <div class="field">
        <label>To Date</label>
        <input type="date" id="rpt_to" value="${today}" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;outline:none;">
      </div>
    </div>
    <input type="hidden" id="rpt_customer" value="${customerId}">`;

  showPopup('üìä', 'Customer Report', c.name + ' ¬∑ ' + c.phone, html, [
    { label:'Generate Report', cls:'btn-primary', action:'generateCustomerReport()' },
    { label:'Cancel', cls:'btn-secondary', action:'closePopup()' }
  ]);
}

function generateCustomerReport() {
  const customerId = document.getElementById('rpt_customer').value;
  const fromDate = document.getElementById('rpt_from').value;
  const toDate = document.getElementById('rpt_to').value;

  if (!customerId) { showToast('Please select a customer', 'error'); return; }
  if (!fromDate || !toDate) { showToast('Please select date range', 'error'); return; }
  if (fromDate > toDate) { showToast('From date must be before To date', 'error'); return; }

  const customers = DB.get('customers') || [];
  const c = customers.find(c => c.id === customerId);
  if (!c) return;

  const orders = DB.get('orders') || [];
  const filtered = orders.filter(o => {
    const d = (o.orderDate || o.createdAt || '').split('T')[0];
    return o.customerPhone === c.phone && d >= fromDate && d <= toDate;
  }).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

  const totalOrders = filtered.length;
  const totalAmount = filtered.reduce((s,o) => s+(o.totalAmount||0), 0);
  const totalPaid = filtered.reduce((s,o) => s+(o.paidAmount||0), 0);
  const totalDue = Math.max(0, totalAmount - totalPaid);
  const completedOrders = filtered.filter(o => o.status === 'delivered').length;
  const pendingOrders = filtered.filter(o => o.status !== 'delivered' && o.status !== 'cancelled').length;
  const cancelledOrders = filtered.filter(o => o.status === 'cancelled').length;

  const html = `
    <!-- Summary Cards -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
      <div style="background:linear-gradient(135deg,var(--orange),var(--orange-light));border-radius:12px;padding:12px;color:white;text-align:center;">
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:24px;">${totalOrders}</div>
        <div style="font-size:11px;opacity:0.85;">Total Orders</div>
      </div>
      <div style="background:linear-gradient(135deg,var(--success),#00A846);border-radius:12px;padding:12px;color:white;text-align:center;">
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:24px;">${completedOrders}</div>
        <div style="font-size:11px;opacity:0.85;">Completed</div>
      </div>
      <div style="background:linear-gradient(135deg,var(--warning),#F57F17);border-radius:12px;padding:12px;color:white;text-align:center;">
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:24px;">${pendingOrders}</div>
        <div style="font-size:11px;opacity:0.85;">Pending</div>
      </div>
      <div style="background:linear-gradient(135deg,var(--danger),#C62828);border-radius:12px;padding:12px;color:white;text-align:center;">
        <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:24px;">${cancelledOrders}</div>
        <div style="font-size:11px;opacity:0.85;">Cancelled</div>
      </div>
    </div>

    <!-- Payment Summary -->
    <div style="background:var(--dark);border-radius:12px;padding:14px;margin-bottom:14px;color:white;">
      <div style="font-weight:700;font-size:12px;opacity:0.6;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">Payment Summary</div>
      <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
        <span style="font-size:13px;opacity:0.8;">Total Amount</span>
        <strong style="font-family:'Nunito',sans-serif;font-size:15px;">‚Çπ${totalAmount.toFixed(0)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
        <span style="font-size:13px;opacity:0.8;">Total Paid</span>
        <strong style="font-family:'Nunito',sans-serif;font-size:15px;color:#69f0ae;">‚Çπ${totalPaid.toFixed(0)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between;padding:5px 0;">
        <span style="font-size:13px;opacity:0.8;">Balance Due</span>
        <strong style="font-family:'Nunito',sans-serif;font-size:15px;color:${totalDue>0?'#ff8a80':'#69f0ae'};">‚Çπ${totalDue.toFixed(0)}</strong>
      </div>
    </div>

    <!-- Period -->
    <div style="text-align:center;font-size:11px;color:var(--text3);margin-bottom:10px;">
      üìÖ ${formatDate(fromDate)} ‚Üí ${formatDate(toDate)}
    </div>

    <!-- Orders List -->
    <div style="font-weight:700;font-size:12px;color:var(--text2);text-transform:uppercase;margin-bottom:8px;">Order Details</div>
    ${filtered.length === 0
      ? '<div class="empty-state"><div class="empty-icon">üìã</div><h3>No orders found</h3><p>No orders in this date range</p></div>'
      : filtered.map(o => {
          const bal = Math.max(0,(o.totalAmount||0)-(o.paidAmount||0));
          const svcNames = (o.services||[]).map(s=>s.serviceName).join(', ');
          return `<div onclick="closePopup();showOrderDetail('${o.id}')" style="padding:10px;background:white;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
              <div>
                <div style="font-weight:700;font-size:13px;color:var(--orange);">${o.orderNo}</div>
                <div style="font-size:11px;color:var(--text2);">${formatDate(o.orderDate||o.createdAt)}</div>
                <div style="font-size:11px;color:var(--text3);margin-top:2px;">${svcNames}</div>
              </div>
              <div style="text-align:right;">
                <span class="status-badge ${getStatusClass(o.status)}">${getStatusLabel(o.status)}</span>
                <div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;margin-top:4px;">‚Çπ${(o.totalAmount||0).toFixed(0)}</div>
                ${bal>0
                  ? `<div style="font-size:10px;color:var(--danger);font-weight:700;">Due: ‚Çπ${bal.toFixed(0)}</div>`
                  : `<div style="font-size:10px;color:var(--success);font-weight:700;">‚úÖ Paid</div>`}
              </div>
            </div>
          </div>`;
        }).join('')
    }`;

  closePopup();
  showPopup('üìä', c.name + ' Report', formatDate(fromDate) + ' to ' + formatDate(toDate), html, [
    { label:'Change Dates', cls:'btn-secondary', action:`closePopup();showCustomerReport('${customerId}')` },
    { label:'Close', cls:'btn-primary', action:'closePopup()' }
  ]);
}

// ============================================================
// REPORTS
// ============================================================
function showReports() {
  if (currentUser.role !== 'admin') { showToast('Admin access required', 'error'); return; }
  const orders = DB.get('orders') || [];
  const now = new Date();

  const thisMonth = orders.filter(o => {
    const d = new Date(o.createdAt);
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  });

  const last7 = orders.filter(o => { const d = new Date(o.createdAt); const diff = (now-d)/(1000*60*60*24); return diff <= 7; });
  const last30 = orders.filter(o => { const d = new Date(o.createdAt); const diff = (now-d)/(1000*60*60*24); return diff <= 30; });

  const revenue30 = last30.reduce((sum,o) => sum+(o.paidAmount||0), 0);
  const pending30 = last30.reduce((sum,o) => sum+Math.max(0,(o.totalAmount||0)-(o.paidAmount||0)), 0);

  // Service breakdown
  const serviceCount = {};
  orders.forEach(o => (o.services||[]).forEach(s => {
    if (!serviceCount[s.serviceName]) serviceCount[s.serviceName] = { count:0, revenue:0 };
    serviceCount[s.serviceName].count++;
    serviceCount[s.serviceName].revenue += s.serviceTotal||0;
  }));

  const html = `
    <div style="margin-bottom:12px;">
      <button class="btn btn-info btn-full" onclick="closePopup();showCustomerReportSelector()">üë§ Customer Report</button>
    </div>
    <div class="report-card">
      <div class="report-card-title">üìä Summary</div>
      <div class="report-row"><span>This Month Orders</span><span class="report-val">${thisMonth.length}</span></div>
      <div class="report-row"><span>Last 7 Days Orders</span><span class="report-val">${last7.length}</span></div>
      <div class="report-row"><span>Last 30 Days Revenue</span><span class="report-val">‚Çπ${revenue30.toFixed(0)}</span></div>
      <div class="report-row"><span>Pending Collections</span><span class="report-val" style="color:var(--danger);">‚Çπ${pending30.toFixed(0)}</span></div>
      <div class="report-row"><span>Total Orders</span><span class="report-val">${orders.length}</span></div>
    </div>
    <div class="report-card">
      <div class="report-card-title">üß∫ Service Breakdown</div>
      ${Object.entries(serviceCount).sort((a,b)=>b[1].revenue-a[1].revenue).map(([name,data]) => `
        <div class="report-row"><span>${name}</span><span><span class="report-val">‚Çπ${data.revenue.toFixed(0)}</span> <span style="font-size:11px;color:var(--text3);">(${data.count} orders)</span></span></div>
      `).join('')}
    </div>`;

  showPopup('üìä', 'Business Reports', 'Admin analytics overview', html, [
    { label:'Close', cls:'btn-secondary btn-full', action:'closePopup()' }
  ]);
}

function showPendingPayments() {
  const orders = DB.get('orders') || [];
  const unpaid = orders.filter(o => (o.totalAmount||0) - (o.paidAmount||0) > 0 && o.status !== 'cancelled');
  const total = unpaid.reduce((sum,o) => sum+((o.totalAmount||0)-(o.paidAmount||0)), 0);

  const html = `
    <div style="background:linear-gradient(135deg,var(--danger),#C62828);border-radius:12px;padding:14px;margin-bottom:12px;color:white;text-align:center;">
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:28px;">‚Çπ${total.toFixed(0)}</div>
      <div style="font-size:13px;opacity:0.8;">${unpaid.length} orders with pending payment</div>
    </div>
    ${unpaid.map(o => {
      const bal = (o.totalAmount||0)-(o.paidAmount||0);
      return `<div onclick="closePopup();showOrderDetail('${o.id}')" style="padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><div style="font-weight:700;">${o.orderNo} - ${o.customerName}</div>
            <div style="font-size:11px;color:var(--text2);">üìû ${o.customerPhone} | ${formatDate(o.dueDate)}</div></div>
          <div style="text-align:right;"><div style="font-weight:800;color:var(--danger);">‚Çπ${bal.toFixed(0)}</div>
            <span class="status-badge ${getStatusClass(o.status)}">${getStatusLabel(o.status)}</span></div>
        </div></div>`;
    }).join('')}`;

  showPopup('üí∏', 'Pending Payments', '', html, [
    { label:'Close', cls:'btn-secondary btn-full', action:'closePopup()' }
  ]);
}

// ============================================================
// RESET SERVICES TO DEFAULT
// ============================================================
function resetServicesToDefault() {
  showConfirm(
    'Reset Services',
    'This will reload ALL services and prices to default. Your existing orders will NOT be affected. Continue?',
    'üîÑ',
    () => {
      DB.set('services', [
        { id:'s1', name:'Dry Cleaning', icon:'üëî', active:true, pricingType:'per_item', items:[
          {name:'Shirt / T-Shirt (Cotton / Formal)', price:70},
          {name:'Pant / Trouser / Jeans (Formal / Cotton)', price:70},
          {name:'Kurta (Ethnic / Cotton)', price:100},
          {name:'Blazer (Dry clean recommended)', price:250},
          {name:'2 Piece (Blazer + Pant)', price:300},
          {name:'3 Piece (Blazer + Pant + Waistcoat)', price:380},
          {name:'Jacket (Light / Heavy)', price:150},
          {name:'Sweater (Knitted / Wool Blend)', price:200},
          {name:'Blouse (Cotton)', price:40},
          {name:'Blouse (Designer)', price:80},
          {name:'Kurti (Casual)', price:70},
          {name:'Kurti (Formal / Fancy)', price:150},
          {name:'Pyjama (Cotton)', price:70},
          {name:'Pyjama (Silk)', price:140},
          {name:'Dress (Kurta, Pyjama, Odhni)', price:150},
          {name:'One Piece (Western / Party Wear)', price:200},
          {name:'Lehenga (Bridal / Heavy Embroidery)', price:400},
          {name:'Bedsheet (Cotton / Printed) - Single', price:70},
          {name:'Bedsheet (Cotton / Printed) - Double', price:130},
          {name:'Curtain (Per Piece - Normal) - Single', price:250},
          {name:'Curtain (Per Piece - Normal) - Double', price:400},
          {name:'Pillow Cover (Per Piece) - Single', price:40},
          {name:'Pillow Cover (Per Piece) - Double', price:80},
          {name:'Quilt / Comforter - Single', price:200},
          {name:'Quilt / Comforter - Double', price:350},
          {name:'Blanket (Light)', price:150},
          {name:'Blanket (Heavy)', price:275},
          {name:'Sofa Cover (Per Seat) - Single', price:90},
          {name:'Sofa Cover (Per Seat) - Double', price:150}
        ]},
        { id:'s2', name:'Wash & Fold', icon:'üß∫', active:true, pricingType:'per_kg', items:[
          {name:'Wash and Fold', price:80}
        ]},
        { id:'s3', name:'Wash & Iron', icon:'üëï', active:true, pricingType:'per_kg', items:[
          {name:'Wash and Iron', price:110}
        ]},
        { id:'s4', name:'Steam Ironing', icon:'‚ô®Ô∏è', active:true, pricingType:'per_item', items:[
          {name:'Shirt / T-Shirt (Cotton / Formal)', price:20},
          {name:'Pant / Trouser / Jeans (Formal / Cotton)', price:20},
          {name:'Kurta (Ethnic / Cotton)', price:30},
          {name:'Blazer (Dry clean recommended)', price:70},
          {name:'2 Piece (Blazer + Pant)', price:80},
          {name:'3 Piece (Blazer + Pant + Waistcoat)', price:120},
          {name:'Jacket (Light / Heavy)', price:30},
          {name:'Sweater (Knitted / Wool Blend)', price:70},
          {name:'Blouse (Cotton / Designer)', price:20},
          {name:'Kurti (Casual)', price:20},
          {name:'Kurti (Formal / Fancy)', price:50},
          {name:'Pyjama (Cotton)', price:20},
          {name:'Pyjama (Silk)', price:40},
          {name:'Dress (Kurta, Pyjama, Odhni)', price:60},
          {name:'One Piece (Western / Party Wear)', price:80},
          {name:'Lehenga (Bridal / Heavy Embroidery)', price:150}
        ]},
        { id:'s5', name:'Shoe Cleaning', icon:'üëü', active:true, pricingType:'per_item', items:[
          {name:'Sports Shoes (Running / Gym)', price:250},
          {name:'Leather Shoes (Formal / Office)', price:280}
        ]},
        { id:'s6', name:'Saree Roll Press', icon:'ü•ª', active:true, pricingType:'per_item', items:[
          {name:'Saree Roll Press', price:60}
        ]},
        { id:'s7', name:'Dying', icon:'üé®', active:true, pricingType:'per_item', items:[
          {name:'Shirt', price:250},
          {name:'Pant', price:250}
        ]},
        { id:'s8', name:'Normal Iron', icon:'üî≤', active:true, pricingType:'per_item', items:[] }
      ]);
      showToast('Services & prices reset successfully! ‚úÖ', 'success');
      refreshDashboard();
    }
  );
}

// ============================================================
// SERVICES MANAGER
// ============================================================
function showServicesManager() {
  const services = DB.get('services') || [];

  const html = `
    <div style="margin-bottom:12px;">
      <button class="btn btn-primary btn-full" onclick="addNewService()">+ Add New Service</button>
    </div>
    <div id="servicesList">
      ${services.map(s => `
        <div style="background:white;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;">
          <span style="font-size:24px;">${s.icon}</span>
          <div style="flex:1;">
            <div style="font-weight:700;">${s.name}</div>
            <div style="font-size:11px;color:var(--text2);">${s.pricingType==='per_kg'?'Per KG':'Per Item'} | ${(s.items||[]).length} items saved</div>
          </div>
          <label class="toggle">
            <input type="checkbox" ${s.active?'checked':''} onchange="toggleServiceActive('${s.id}',this.checked)">
            <span class="toggle-slider"></span>
          </label>
          <button class="btn btn-secondary btn-sm" onclick="editService('${s.id}')">‚úèÔ∏è</button>
          <button class="btn btn-sm" style="background:rgba(255,107,0,0.1);color:var(--orange)" onclick="showServiceItems('${s.id}')">üìã</button>
        </div>`).join('')}
    </div>`;

  showPopup('üß∫', 'Services & Pricing', 'Manage your services', html, [
    { label:'Close', cls:'btn-secondary btn-full', action:'closePopup()' }
  ]);
}

function addNewService() {
  closePopup();
  const name = prompt('Enter service name:');
  if (!name) return;
  const icon = prompt('Enter emoji icon (e.g. üëï):') || 'üß∫';
  const pricingType = confirm('Price per KG? (Cancel = Per Item)') ? 'per_kg' : 'per_item';

  const services = DB.get('services') || [];
  services.push({ id:'s'+Date.now(), name, icon, active:true, pricingType, items:[] });
  DB.set('services', services);
  showToast('Service "' + name + '" added! ‚úÖ', 'success');
  showServicesManager();
}

function toggleServiceActive(serviceId, active) {
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (svc) { svc.active = active; DB.set('services', services); }
  showToast('Service ' + (active?'enabled':'disabled'), active?'success':'warning');
}

function editService(serviceId) {
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc) return;
  closePopup();
  const name = prompt('Service name:', svc.name);
  if (!name) return;
  const icon = prompt('Icon:', svc.icon) || svc.icon;
  svc.name = name; svc.icon = icon;
  DB.set('services', services);
  showToast('Service updated! ‚úÖ', 'success');
  showServicesManager();
}

function showServiceItems(serviceId) {
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc) return;
  closePopup();

  const renderItemsList = () => {
    return (svc.items||[]).map((item,i) => `
      <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="flex:1;font-weight:600;">${item.name}</div>
        <div style="font-family:'Nunito',sans-serif;font-weight:800;color:var(--orange);">‚Çπ${item.price}</div>
        <button class="btn btn-sm btn-secondary" onclick="editItem('${serviceId}',${i})">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger" onclick="deleteItem('${serviceId}',${i})">üóë</button>
      </div>`).join('');
  };

  const html = `<div id="itemsListBody">${renderItemsList()}</div>
    <button class="btn btn-primary btn-full mt-12" onclick="addNewItem('${serviceId}')">+ Add Item</button>`;

  showPopup('üìã', svc.name + ' Items', 'Price list for ' + svc.name, html, [
    { label:'Back', cls:'btn-secondary', action:'closePopup();showServicesManager()' },
    { label:'Close', cls:'btn-secondary', action:'closePopup()' }
  ]);
}

function addNewItem(serviceId) {
  const name = prompt('Item name:');
  if (!name) return;
  const price = parseFloat(prompt('Price (‚Çπ):'));
  if (!price || isNaN(price)) return;
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc) return;
  if (!svc.items) svc.items = [];
  svc.items.push({ name, price });
  DB.set('services', services);
  showToast('Item added! ‚úÖ', 'success');
  showServiceItems(serviceId);
}

function editItem(serviceId, index) {
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc || !svc.items[index]) return;
  const item = svc.items[index];
  const name = prompt('Item name:', item.name);
  if (!name) return;
  const price = parseFloat(prompt('Price (‚Çπ):', item.price));
  if (isNaN(price)) return;
  svc.items[index] = { name, price };
  DB.set('services', services);
  showToast('Item updated! ‚úÖ', 'success');
  showServiceItems(serviceId);
}

function deleteItem(serviceId, index) {
  const services = DB.get('services') || [];
  const svc = services.find(s => s.id === serviceId);
  if (!svc) return;
  svc.items.splice(index, 1);
  DB.set('services', services);
  showToast('Item deleted', 'warning');
  showServiceItems(serviceId);
}

// ============================================================
// WHATSAPP TEMPLATES
// ============================================================
function showWhatsAppTemplates() {
  const templates = DB.get('whatsappTemplates') || {};

  const html = `
    <div style="margin-bottom:16px;">
      <div style="font-weight:700;font-size:13px;margin-bottom:6px;color:var(--orange);">üì© Order Received Template</div>
      <textarea id="tmpl_orderReceived" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:'Poppins',sans-serif;min-height:150px;">${templates.orderReceived||''}</textarea>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-weight:700;font-size:13px;margin-bottom:6px;color:var(--success);">‚úÖ Order Ready Template</div>
      <textarea id="tmpl_orderReady" style="width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:'Poppins',sans-serif;min-height:120px;">${templates.orderReady||''}</textarea>
    </div>
    <div style="background:rgba(255,107,0,0.08);border-radius:10px;padding:10px;font-size:11px;color:var(--text2);">
      <strong>Available variables:</strong><br>
      {customerName}, {orderNo}, {services}, {totalAmount}, {advancePaid}, {balanceDue}, {dueDate}, {shopName}, {shopPhone}
    </div>`;

  showPopup('üí¨', 'WhatsApp Templates', 'Edit message templates', html, [
    { label:'Save Templates', cls:'btn-primary', action:'saveWhatsAppTemplates()' },
    { label:'Cancel', cls:'btn-secondary', action:'closePopup()' }
  ]);
}

function saveWhatsAppTemplates() {
  const templates = {
    orderReceived: document.getElementById('tmpl_orderReceived').value,
    orderReady: document.getElementById('tmpl_orderReady').value
  };
  DB.set('whatsappTemplates', templates);
  showToast('Templates saved! ‚úÖ', 'success');
  closePopup();
}

// ============================================================
// SHOP SETTINGS
// ============================================================
function showShopSettings() {
  const shop = DB.get('shopSettings') || {};
  const html = `
    <div class="field"><label>Shop Name</label><input type="text" id="ss_name" value="${shop.name||''}"></div>
    <div class="field"><label>Address</label><textarea id="ss_address" style="min-height:70px;">${shop.address||''}</textarea></div>
    <div class="field"><label>Phone</label><input type="tel" id="ss_phone" value="${shop.phone||''}"></div>
    <div class="field"><label>Working Hours</label><input type="text" id="ss_hours" value="${shop.hours||''}"></div>
    <div class="field"><label>Order Prefix (e.g. TWL)</label><input type="text" id="ss_prefix" value="${shop.orderPrefix||'TWL'}" maxlength="6" style="text-transform:uppercase;"></div>`;

  showPopup('üè™', 'Shop Settings', 'Update your shop information', html, [
    { label:'Save', cls:'btn-primary', action:'saveShopSettings()' },
    { label:'Cancel', cls:'btn-secondary', action:'closePopup()' }
  ]);
}

function saveShopSettings() {
  const shop = {
    name: document.getElementById('ss_name').value.trim(),
    address: document.getElementById('ss_address').value.trim(),
    phone: document.getElementById('ss_phone').value.trim(),
    hours: document.getElementById('ss_hours').value.trim(),
    orderPrefix: document.getElementById('ss_prefix').value.trim().toUpperCase()
  };
  DB.set('shopSettings', shop);
  showToast('Shop settings saved! ‚úÖ', 'success');
  closePopup();
  refreshDashboard();
}

// ============================================================
// USER MANAGER
// ============================================================
function showUserManager() {
  const users = DB.get('users') || [];
  const roleLabels = { admin:'üëë Admin', operator:'‚öôÔ∏è Operator', viewer:'üëÅÔ∏è Viewer' };

  const html = `
    <div style="margin-bottom:12px;">
      <button class="btn btn-primary btn-full" onclick="addNewUser()">+ Add New User</button>
    </div>
    ${users.map(u => `
      <div style="background:white;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--orange),var(--yellow));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16px;color:white;font-family:'Nunito',sans-serif;">${u.name.charAt(0)}</div>
          <div style="flex:1;">
            <div style="font-weight:700;">${u.name}</div>
            <div style="font-size:12px;color:var(--text2);">@${u.username} | ${roleLabels[u.role]||u.role}</div>
          </div>
          <label class="toggle">
            <input type="checkbox" ${u.active?'checked':''} ${u.id===currentUser.id?'disabled':''} onchange="toggleUserActive('${u.id}',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div style="display:flex;gap:6px;margin-top:10px;">
          <button class="btn btn-secondary btn-sm" onclick="editUser('${u.id}')">‚úèÔ∏è Edit</button>
          <button class="btn btn-sm" style="background:rgba(255,107,0,0.1);color:var(--orange)" onclick="resetUserPassword('${u.id}')">üîë Reset Password</button>
          ${u.id !== currentUser.id ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">üóë</button>` : ''}
        </div>
      </div>`).join('')}`;

  showPopup('üë•', 'User Management', 'Manage app users', html, [
    { label:'Close', cls:'btn-secondary btn-full', action:'closePopup()' }
  ]);
}

function addNewUser() {
  closePopup();
  const name = prompt('Full name:');
  if (!name) return;
  const username = prompt('Username (for login):');
  if (!username) return;
  const password = prompt('Password:');
  if (!password) return;
  const roleChoice = prompt('Role (1=admin, 2=operator, 3=viewer):');
  const roles = {'1':'admin','2':'operator','3':'viewer'};
  const role = roles[roleChoice] || 'operator';

  const users = DB.get('users') || [];
  if (users.find(u => u.username === username)) { showToast('Username already exists!', 'error'); return; }

  users.push({ id:'u'+Date.now(), username, password, name, role, active:true, createdAt:new Date().toISOString() });
  DB.set('users', users);
  showToast('User "' + name + '" added! ‚úÖ', 'success');
  showUserManager();
}

function editUser(userId) {
  closePopup();
  const users = DB.get('users') || [];
  const user = users.find(u => u.id === userId);
  if (!user) return;
  const name = prompt('Full name:', user.name);
  if (!name) return;
  const roleChoice = prompt('Role (1=admin, 2=operator, 3=viewer):', user.role==='admin'?'1':user.role==='operator'?'2':'3');
  const roles = {'1':'admin','2':'operator','3':'viewer'};
  user.name = name;
  user.role = roles[roleChoice] || user.role;
  DB.set('users', users);
  showToast('User updated! ‚úÖ', 'success');
  showUserManager();
}

function resetUserPassword(userId) {
  closePopup();
  const newPass = prompt('Enter new password:');
  if (!newPass || newPass.length < 4) { showToast('Password too short (min 4 chars)', 'error'); return; }
  const users = DB.get('users') || [];
  const user = users.find(u => u.id === userId);
  if (user) { user.password = newPass; DB.set('users', users); showToast('Password reset for ' + user.name + '! ‚úÖ', 'success'); }
  showUserManager();
}

function deleteUser(userId) {
  showConfirm('Delete User', 'Delete this user? They will lose access immediately.', 'üóëÔ∏è', () => {
    const users = DB.get('users') || [];
    DB.set('users', users.filter(u => u.id !== userId));
    showToast('User deleted', 'warning');
    closePopup();
    showUserManager();
  });
}

function toggleUserActive(userId, active) {
  const users = DB.get('users') || [];
  const user = users.find(u => u.id === userId);
  if (user) { user.active = active; DB.set('users', users); showToast('User ' + (active?'activated':'deactivated'), active?'success':'warning'); }
}

// ============================================================
// CHANGE PASSWORD
// ============================================================
function showChangePassword() {
  const html = `
    <div class="field"><label>Current Password</label><input type="password" id="cp_current" placeholder="Current password"></div>
    <div class="field"><label>New Password</label><input type="password" id="cp_new" placeholder="New password (min 4 chars)"></div>
    <div class="field"><label>Confirm Password</label><input type="password" id="cp_confirm" placeholder="Confirm new password"></div>`;

  showPopup('üîë', 'Change Password', 'Update your login password', html, [
    { label:'Save', cls:'btn-primary', action:'saveNewPassword()' },
    { label:'Cancel', cls:'btn-secondary', action:'closePopup()' }
  ]);
}

function saveNewPassword() {
  const current = document.getElementById('cp_current').value;
  const newPass = document.getElementById('cp_new').value;
  const confirm = document.getElementById('cp_confirm').value;

  if (current !== currentUser.password) { showToast('Current password incorrect', 'error'); return; }
  if (newPass.length < 4) { showToast('New password too short', 'error'); return; }
  if (newPass !== confirm) { showToast('Passwords do not match', 'error'); return; }

  const users = DB.get('users') || [];
  const user = users.find(u => u.id === currentUser.id);
  if (user) { user.password = newPass; currentUser.password = newPass; DB.set('users', users); }
  showToast('Password changed! ‚úÖ', 'success');
  closePopup();
}

// ============================================================
// RESET ALL DATA (ADMIN ONLY)
// ============================================================
function resetAllData() {
  if (currentUser.role !== 'admin') {
    showToast('Only Admin can reset data', 'error');
    return;
  }

  // Double confirmation
  showConfirm(
    '‚ö†Ô∏è DANGER ZONE',
    'This will DELETE ALL data including orders, customers, and settings. This action CANNOT be undone!\n\nAre you absolutely sure?',
    'üóëÔ∏è',
    () => {
      // Second confirmation with typed confirmation
      const confirmText = prompt('Type "DELETE ALL DATA" to confirm:');
      if (confirmText !== 'DELETE ALL DATA') {
        showToast('Reset cancelled', 'warning');
        return;
      }

      // Export backup before deleting (safety measure)
      const backupData = {
        version: '1.0',
        exportedAt: new Date().toISOString(),
        exportedBy: currentUser.name,
        note: 'Auto-backup before reset',
        shopSettings: DB.get('shopSettings'),
        users: DB.get('users'),
        services: DB.get('services'),
        orders: DB.get('orders'),
        customers: DB.get('customers'),
        orderCounter: DB.get('orderCounter'),
        whatsappTemplates: DB.get('whatsappTemplates')
      };
      
      // Auto-download backup
      const json = JSON.stringify(backupData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'TurboWash_Backup_Before_Reset_' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);

      // Delete all data
      DB.del('orders');
      DB.del('customers');
      DB.del('orderCounter');
      DB.del('shareCounts');
      DB.del('expenses');
      DB.del('inventory');
      DB.del('activityLog');
      DB.del('lastBackup');
      DB.del('lastOverduePopup');

      showToast('All data deleted! Backup saved. Reloading...', 'success');
      
      // Reload page after 2 seconds
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    }
  );
}

// ============================================================
// BACKUP & SYNC
// ============================================================
function exportData() {
  const data = {
    version: '1.0',
    exportedAt: new Date().toISOString(),
    exportedBy: currentUser.name,
    shopSettings: DB.get('shopSettings'),
    users: DB.get('users'),
    services: DB.get('services'),
    orders: DB.get('orders'),
    customers: DB.get('customers'),
    orderCounter: DB.get('orderCounter'),
    whatsappTemplates: DB.get('whatsappTemplates')
  };

  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const dateStr = new Date().toISOString().split('T')[0].replace(/-/g,'');
  a.href = url; a.download = 'TurboWash_Backup_' + dateStr + '.json';
  a.click(); URL.revokeObjectURL(url);

  DB.set('lastBackup', new Date().toISOString());
  updateLastBackup();
  showToast('Backup exported! üì§', 'success');
}

function importData() {
  document.getElementById('importFileInput').click();
}

function processImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.version || !data.orders) { showToast('Invalid backup file!', 'error'); return; }

      showConfirm('Import Data', `Import backup from ${data.exportedAt?formatDateTime(data.exportedAt):'unknown date'}?\n\nThis will MERGE with existing data (orders with same ID will be updated).`, 'üì•', () => {
        // Merge orders
        const existingOrders = DB.get('orders') || [];
        const importOrders = data.orders || [];
        const merged = [...existingOrders];
        importOrders.forEach(imp => {
          const idx = merged.findIndex(o => o.id === imp.id);
          if (idx > -1) merged[idx] = imp; else merged.push(imp);
        });
        DB.set('orders', merged);

        // Merge customers
        const existingCust = DB.get('customers') || [];
        const importCust = data.customers || [];
        const mergedCust = [...existingCust];
        importCust.forEach(imp => {
          const idx = mergedCust.findIndex(c => c.id === imp.id);
          if (idx > -1) mergedCust[idx] = imp; else mergedCust.push(imp);
        });
        DB.set('customers', mergedCust);

        if (data.services) DB.set('services', data.services);
        if (data.whatsappTemplates) DB.set('whatsappTemplates', data.whatsappTemplates);
        if (data.orderCounter) {
          const existing = DB.get('orderCounter') || 0;
          DB.set('orderCounter', Math.max(existing, data.orderCounter));
        }

        showToast('Data imported successfully! ‚úÖ', 'success');
        refreshDashboard();
        renderOrders();
        renderCustomers();
      });
    } catch(err) {
      showToast('Error reading backup file!', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function updateLastBackup() {
  const last = DB.get('lastBackup');
  const el = document.getElementById('lastBackupText');
  if (el) el.textContent = last ? 'Last backup: ' + formatDate(last) : 'Last backup: Never';
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function showNotifications() {
  const orders = DB.get('orders') || [];
  const overdue = orders.filter(o => isOverdue(o));
  const dueToday = orders.filter(o => isDueToday(o));

  if (overdue.length === 0 && dueToday.length === 0) {
    showToast('No notifications! All clear ‚úÖ', 'success');
    return;
  }

  let html = '';
  if (overdue.length > 0) {
    html += `<div style="font-weight:700;font-size:12px;color:var(--danger);margin-bottom:6px;">üö® OVERDUE (${overdue.length})</div>`;
    html += overdue.map(o => `<div onclick="closePopup();showOrderDetail('${o.id}')" style="padding:8px;background:rgba(244,67,54,0.08);border-radius:8px;margin-bottom:6px;cursor:pointer;">
      <div style="font-weight:700;font-size:13px;">${o.orderNo} - ${o.customerName}</div>
      <div style="font-size:11px;color:var(--danger);">Due: ${formatDate(o.dueDate)}</div>
    </div>`).join('');
  }
  if (dueToday.length > 0) {
    html += `<div style="font-weight:700;font-size:12px;color:var(--warning);margin:10px 0 6px;">‚ö†Ô∏è DUE TODAY (${dueToday.length})</div>`;
    html += dueToday.map(o => `<div onclick="closePopup();showOrderDetail('${o.id}')" style="padding:8px;background:rgba(255,179,0,0.08);border-radius:8px;margin-bottom:6px;cursor:pointer;">
      <div style="font-weight:700;font-size:13px;">${o.orderNo} - ${o.customerName}</div>
      <div style="font-size:11px;color:var(--warning);">Due Today</div>
    </div>`).join('');
  }

  showPopup('üîî', 'Notifications', overdue.length + ' overdue, ' + dueToday.length + ' due today', html, [
    { label:'View Due Dates', cls:'btn-primary', action:'switchPage("pageDueDate");closePopup()' },
    { label:'Close', cls:'btn-secondary', action:'closePopup()' }
  ]);
}

function showUserMenu() {
  const roleLabels = { admin:'üëë Admin', operator:'‚öôÔ∏è Operator', viewer:'üëÅÔ∏è Viewer' };
  const html = `
    <div style="text-align:center;padding:8px 0 16px;">
      <div style="width:64px;height:64px;border-radius:20px;background:linear-gradient(135deg,var(--orange),var(--yellow));display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:white;margin:0 auto 8px;font-family:'Nunito',sans-serif;">${currentUser.name.charAt(0)}</div>
      <div style="font-weight:800;font-size:18px;">${currentUser.name}</div>
      <div style="font-size:13px;color:var(--text2);">@${currentUser.username}</div>
      <span class="chip chip-orange" style="margin-top:6px;">${roleLabels[currentUser.role]}</span>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <button class="btn btn-secondary btn-full" onclick="closeModal('userMenuModal');showChangePassword()">üîë Change Password</button>
      <button class="btn btn-danger btn-full" onclick="doLogout()">üö™ Logout</button>
    </div>`;
  document.getElementById('userMenuBody').innerHTML = html;
  openModal('userMenuModal');
}

// ============================================================
// MODAL/POPUP HELPERS
// ============================================================
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('active'); });
});

function showPopup(icon, title, msg, bodyHtml, buttons) {
  document.getElementById('popupIcon').textContent = icon;
  document.getElementById('popupTitle').textContent = title;
  document.getElementById('popupMsg').textContent = msg;
  document.getElementById('popupBody').innerHTML = bodyHtml;
  document.getElementById('popupFooter').innerHTML = buttons.map(b =>
    `<button class="btn ${b.cls}" style="flex:1" onclick="${b.action}">${b.label}</button>`
  ).join('');
  document.getElementById('genericPopup').classList.add('active');
}

function closePopup() { document.getElementById('genericPopup').classList.remove('active'); }

function showConfirm(title, msg, icon, onConfirm) {
  showPopup(icon||'‚ùì', title, msg, '', [
    { label:'Confirm', cls:'btn-danger', action:'confirmAction()' },
    { label:'Cancel', cls:'btn-secondary', action:'closePopup()' }
  ]);
  window._confirmCallback = onConfirm;
}

function confirmAction() {
  closePopup();
  if (window._confirmCallback) { window._confirmCallback(); window._confirmCallback = null; }
}

// ============================================================
// TOAST
// ============================================================
let toastTimeout;
function showToast(msg, type) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show' + (type?' '+type:'');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => toast.classList.remove('show'), 3000);
}

// ============================================================
// EMBED LOGO (store in localStorage)
// ============================================================
function embedLogo() {
  // Logo removed - will be added in future
}

// ============================================================
// INIT
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  initApp();
});
</script>
</body>
</html>
